<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#FF8FAB">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ì•„ê¸°ì¼ê¸°">
<link rel="manifest" href="manifest.json">
<title>ì•„ê¸°ì¼ê¸° ğŸ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --pink: #FF8FAB;
    --pink-light: #FFD6E0;
    --pink-pale: #FFF0F4;
    --mint: #A8E6CF;
    --mint-light: #D4F5E9;
    --mint-pale: #F0FBF6;
    --yellow: #FFD93D;
    --yellow-pale: #FFFBEC;
    --purple: #C9B8FF;
    --purple-pale: #F3F0FF;
    --blue: #93C6F5;
    --blue-pale: #EBF5FF;
    --orange: #FFB347;
    --text-dark: #2D2D2D;
    --text-mid: #6B6B6B;
    --text-light: #ABABAB;
    --white: #FFFFFF;
    --bg: #FFF8FA;
    --card-shadow: 0 4px 20px rgba(255,143,171,0.15);
    --radius: 20px;
    --radius-sm: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    min-height: 100vh;
    max-width: 430px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
  }

  /* â”€â”€ SPLASH SCREEN â”€â”€ */
  #splash {
    position: fixed; inset: 0; z-index: 9999;
    background: linear-gradient(135deg, #FF8FAB 0%, #FFB3C6 40%, #C9B8FF 100%);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
  }
  #splash .logo { font-size: 72px; animation: bounce 1s infinite alternate; }
  #splash h1 { font-family: 'Nunito', sans-serif; font-size: 32px; font-weight: 900; color: white; margin-top: 16px; letter-spacing: -0.5px; }
  #splash p { color: rgba(255,255,255,0.85); margin-top: 8px; font-size: 15px; }
  @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-12px); } }

  /* â”€â”€ ONBOARDING â”€â”€ */
  #onboarding {
    display: none; position: fixed; inset: 0; z-index: 999;
    background: var(--bg); overflow-y: auto;
  }
  .onboard-header {
    background: linear-gradient(135deg, #FF8FAB, #C9B8FF);
    padding: 60px 24px 40px;
    text-align: center; border-radius: 0 0 40px 40px;
  }
  .onboard-header .emoji { font-size: 64px; }
  .onboard-header h2 { font-family: 'Nunito', sans-serif; font-size: 26px; font-weight: 900; color: white; margin-top: 12px; }
  .onboard-header p { color: rgba(255,255,255,0.9); margin-top: 6px; font-size: 14px; }
  .onboard-body { padding: 28px 20px 40px; }
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; font-size: 13px; font-weight: 700; color: var(--text-mid); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .form-group input, .form-group select {
    width: 100%; padding: 14px 16px; border: 2px solid var(--pink-light);
    border-radius: var(--radius-sm); font-size: 16px; font-family: inherit;
    background: white; color: var(--text-dark); outline: none;
    transition: border-color 0.2s;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--pink); }
  .gender-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .gender-btn {
    padding: 16px; border: 2px solid var(--pink-light); border-radius: var(--radius-sm);
    background: white; font-size: 24px; cursor: pointer; transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
  }
  .gender-btn span { font-size: 13px; font-weight: 700; color: var(--text-mid); }
  .gender-btn.selected { border-color: var(--pink); background: var(--pink-pale); }
  .preterm-row { display: flex; align-items: center; gap: 12px; }
  .toggle-switch { position: relative; width: 52px; height: 28px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0; background: #ddd; border-radius: 28px; cursor: pointer;
    transition: 0.3s;
  }
  .toggle-slider:before {
    content: ''; position: absolute; width: 22px; height: 22px;
    left: 3px; top: 3px; background: white; border-radius: 50%; transition: 0.3s;
  }
  .toggle-switch input:checked + .toggle-slider { background: var(--pink); }
  .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
  .btn-primary {
    width: 100%; padding: 18px; background: linear-gradient(135deg, var(--pink), var(--purple));
    border: none; border-radius: var(--radius); font-size: 17px; font-weight: 800;
    color: white; cursor: pointer; font-family: 'Nunito', sans-serif;
    letter-spacing: 0.3px; transition: transform 0.15s, box-shadow 0.15s;
    box-shadow: 0 6px 20px rgba(255,143,171,0.4);
  }
  .btn-primary:active { transform: scale(0.97); }

  /* â”€â”€ AUTH SCREEN â”€â”€ */
  #auth-screen {
    display: none; position: fixed; inset: 0; z-index: 998;
    background: linear-gradient(135deg, #FF8FAB 0%, #FFB3C6 40%, #C9B8FF 100%);
    align-items: center; justify-content: center; flex-direction: column;
    padding: 40px;
  }
  #auth-screen .auth-card {
    background: white; border-radius: 28px; padding: 40px 32px;
    width: 100%; max-width: 360px; text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  }
  #auth-screen .auth-emoji { font-size: 56px; }
  #auth-screen h2 { font-family: 'Nunito', sans-serif; font-size: 24px; font-weight: 900; margin-top: 12px; color: var(--text-dark); }
  #auth-screen p { font-size: 14px; color: var(--text-mid); margin-top: 8px; line-height: 1.6; }
  .btn-google {
    width: 100%; margin-top: 28px; padding: 16px; border: 2px solid #e0e0e0;
    border-radius: var(--radius-sm); background: white; font-size: 15px; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px;
    font-family: inherit; transition: all 0.2s; color: var(--text-dark);
  }
  .btn-google:hover { background: #f8f8f8; border-color: var(--pink); }
  .btn-google svg { width: 20px; height: 20px; }

  /* â”€â”€ MAIN APP â”€â”€ */
  #app { display: none; padding-bottom: 80px; }

  /* Header */
  .app-header {
    background: linear-gradient(135deg, #FF8FAB 0%, #FFB3C6 60%, #C9B8FF 100%);
    padding: 48px 20px 24px;
    position: relative; overflow: hidden;
  }
  .app-header::before {
    content: ''; position: absolute; top: -30px; right: -30px;
    width: 150px; height: 150px; border-radius: 50%;
    background: rgba(255,255,255,0.15);
  }
  .app-header::after {
    content: ''; position: absolute; bottom: -20px; left: 20px;
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
  }
  .header-top { display: flex; justify-content: space-between; align-items: center; }
  .baby-info h1 { font-family: 'Nunito', sans-serif; font-size: 24px; font-weight: 900; color: white; }
  .baby-info p { font-size: 13px; color: rgba(255,255,255,0.85); margin-top: 2px; }
  .header-avatar {
    width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center; font-size: 24px;
    border: 2px solid rgba(255,255,255,0.5); cursor: pointer;
  }
  .last-feed-card {
    background: rgba(255,255,255,0.25); backdrop-filter: blur(10px);
    border-radius: var(--radius-sm); padding: 12px 16px; margin-top: 16px;
    display: flex; justify-content: space-between; align-items: center;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .last-feed-card .lf-label { font-size: 12px; color: rgba(255,255,255,0.8); }
  .last-feed-card .lf-value { font-family: 'Nunito', sans-serif; font-size: 18px; font-weight: 800; color: white; }
  .last-feed-card .lf-sub { font-size: 11px; color: rgba(255,255,255,0.7); }

  /* Quick Actions */
  .section-title {
    padding: 20px 20px 12px;
    font-family: 'Nunito', sans-serif; font-size: 18px; font-weight: 800; color: var(--text-dark);
  }
  .quick-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 12px; padding: 0 16px;
  }
  .quick-btn {
    background: white; border: none; border-radius: var(--radius);
    padding: 18px 8px; cursor: pointer; transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    box-shadow: var(--card-shadow);
    position: relative; overflow: hidden;
  }
  .quick-btn::before {
    content: ''; position: absolute; inset: 0; opacity: 0;
    transition: opacity 0.2s;
  }
  .quick-btn:active { transform: scale(0.94); }
  .quick-btn .q-emoji { font-size: 32px; }
  .quick-btn .q-label { font-size: 12px; font-weight: 700; color: var(--text-mid); }
  .quick-btn.feed { background: linear-gradient(135deg, #FFF0F4, #FFE4EC); }
  .quick-btn.sleep { background: linear-gradient(135deg, #EBF5FF, #D6EEFF); }
  .quick-btn.diaper { background: linear-gradient(135deg, #F0FBF6, #D8F5E9); }
  .quick-btn.bath { background: linear-gradient(135deg, #F3F0FF, #E8E0FF); }
  .quick-btn.temp { background: linear-gradient(135deg, #FFFBEC, #FFF3CC); }
  .quick-btn.memo { background: linear-gradient(135deg, #FFF8F0, #FFE8CC); }

  /* Today Summary */
  .summary-row {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; padding: 0 16px; margin-top: 4px;
  }
  .summary-card {
    background: white; border-radius: var(--radius-sm);
    padding: 14px 10px; text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .summary-card .s-num { font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 900; }
  .summary-card .s-unit { font-size: 11px; color: var(--text-light); }
  .summary-card .s-label { font-size: 11px; color: var(--text-mid); font-weight: 600; margin-top: 4px; }
  .summary-card.pink .s-num { color: var(--pink); }
  .summary-card.blue .s-num { color: var(--blue); }
  .summary-card.mint .s-num { color: #3DBE8A; }

  /* Timeline */
  .timeline { padding: 0 16px; }
  .timeline-item {
    display: flex; gap: 14px; padding: 12px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    animation: fadeInUp 0.3s ease;
  }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .tl-icon {
    width: 44px; height: 44px; border-radius: 14px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
  }
  .tl-icon.feed { background: var(--pink-pale); }
  .tl-icon.sleep { background: var(--blue-pale); }
  .tl-icon.diaper { background: var(--mint-pale); }
  .tl-icon.bath { background: var(--purple-pale); }
  .tl-icon.temp { background: var(--yellow-pale); }
  .tl-icon.memo { background: #FFF5EE; }
  .tl-content { flex: 1; }
  .tl-title { font-size: 14px; font-weight: 700; }
  .tl-detail { font-size: 12px; color: var(--text-mid); margin-top: 2px; }
  .tl-time { font-size: 11px; color: var(--text-light); white-space: nowrap; margin-top: 2px; }
  .tl-actions { display: flex; gap: 6px; align-items: flex-start; }
  .tl-del-btn {
    background: none; border: none; cursor: pointer; font-size: 14px;
    color: var(--text-light); padding: 4px; border-radius: 8px;
    transition: all 0.2s;
  }
  .tl-del-btn:hover { background: #ffe0e0; color: #e05555; }
  .empty-timeline {
    text-align: center; padding: 40px 20px; color: var(--text-light);
  }
  .empty-timeline .et-emoji { font-size: 48px; }
  .empty-timeline p { margin-top: 12px; font-size: 14px; }

  /* Bottom Nav */
  .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 430px;
    background: white; border-top: 1px solid rgba(0,0,0,0.08);
    display: flex; height: 68px; z-index: 100;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
  }
  .nav-btn {
    flex: 1; border: none; background: none; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; transition: all 0.2s; padding: 8px 0;
  }
  .nav-btn .nav-icon { font-size: 22px; }
  .nav-btn .nav-label { font-size: 10px; font-weight: 700; color: var(--text-light); }
  .nav-btn.active .nav-label { color: var(--pink); }
  .nav-btn.active .nav-icon { transform: scale(1.15); }

  /* Pages */
  .page { display: none; }
  .page.active { display: block; }

  /* Stats Page */
  .stats-container { padding: 0 16px 20px; }
  .chart-card {
    background: white; border-radius: var(--radius); padding: 20px;
    box-shadow: var(--card-shadow); margin-bottom: 16px;
  }
  .chart-title { font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 800; margin-bottom: 16px; color: var(--text-dark); }
  .bar-chart { display: flex; gap: 8px; align-items: flex-end; height: 120px; }
  .bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
  .bar { width: 100%; border-radius: 8px 8px 0 0; min-height: 4px; transition: height 0.5s ease; }
  .bar.pink { background: linear-gradient(to top, var(--pink), #FFB3C6); }
  .bar.blue { background: linear-gradient(to top, var(--blue), #B8DCFF); }
  .bar.mint { background: linear-gradient(to top, var(--mint), #C8F0DC); }
  .bar-label { font-size: 10px; color: var(--text-light); }
  .bar-val { font-size: 10px; font-weight: 700; color: var(--text-mid); }
  .pie-container { display: flex; align-items: center; gap: 20px; }
  canvas#pieChart { max-width: 120px; max-height: 120px; }
  .pie-legend { flex: 1; }
  .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* Growth Page */
  .growth-container { padding: 0 16px 20px; }
  .growth-card {
    background: white; border-radius: var(--radius); padding: 20px;
    box-shadow: var(--card-shadow); margin-bottom: 16px;
  }
  .growth-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
  .g-input-group label { font-size: 12px; font-weight: 700; color: var(--text-mid); display: block; margin-bottom: 6px; }
  .g-input-group input {
    width: 100%; padding: 12px 14px; border: 2px solid var(--pink-light);
    border-radius: var(--radius-sm); font-size: 16px; font-family: inherit;
    background: white; outline: none;
  }
  .g-input-group input:focus { border-color: var(--pink); }
  .btn-save-growth {
    width: 100%; margin-top: 14px; padding: 14px; background: linear-gradient(135deg, var(--pink), var(--purple));
    border: none; border-radius: var(--radius-sm); color: white; font-size: 15px;
    font-weight: 700; cursor: pointer; font-family: inherit;
  }
  .growth-chart-wrap { margin-top: 16px; }
  .growth-percentile { 
    display: flex; justify-content: center; gap: 20px; 
    flex-wrap: wrap; margin-top: 12px;
  }
  .p-badge {
    background: var(--pink-pale); border-radius: 20px; padding: 6px 14px;
    font-size: 13px; font-weight: 700; color: var(--pink);
  }
  .vaccine-list { margin-top: 12px; }
  .vaccine-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .vaccine-check {
    width: 24px; height: 24px; border-radius: 8px; border: 2px solid var(--pink-light);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    flex-shrink: 0; transition: all 0.2s; background: white;
  }
  .vaccine-check.done { background: var(--pink); border-color: var(--pink); }
  .vaccine-check.done::after { content: 'âœ“'; color: white; font-size: 13px; font-weight: 900; }
  .vaccine-info { flex: 1; }
  .vaccine-info .v-name { font-size: 14px; font-weight: 700; }
  .vaccine-info .v-when { font-size: 12px; color: var(--text-mid); }
  .vaccine-due { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
  .vaccine-due.soon { background: #FFF3CC; color: #B8860B; }
  .vaccine-due.done { background: var(--mint-light); color: #2A8055; }
  .vaccine-due.upcoming { background: var(--blue-pale); color: #2060A0; }

  /* Family Page */
  .family-container { padding: 0 16px 20px; }
  .family-card {
    background: white; border-radius: var(--radius); padding: 20px;
    box-shadow: var(--card-shadow); margin-bottom: 16px;
  }
  .family-card h3 { font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 800; margin-bottom: 14px; }
  .invite-box {
    background: var(--pink-pale); border-radius: var(--radius-sm); padding: 14px;
    font-size: 13px; color: var(--text-mid); word-break: break-all;
    border: 1px dashed var(--pink); margin-bottom: 12px;
    font-family: monospace;
  }
  .btn-share {
    width: 100%; padding: 14px; background: var(--pink); border: none;
    border-radius: var(--radius-sm); color: white; font-size: 15px; font-weight: 700;
    cursor: pointer; font-family: inherit; display: flex; align-items: center;
    justify-content: center; gap: 8px; transition: all 0.2s;
  }
  .btn-share:active { transform: scale(0.97); }
  .member-list { }
  .member-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .member-avatar {
    width: 40px; height: 40px; border-radius: 50%; background: var(--pink-light);
    display: flex; align-items: center; justify-content: center; font-size: 18px;
    flex-shrink: 0;
  }
  .member-info .m-name { font-size: 14px; font-weight: 700; }
  .member-info .m-role { font-size: 12px; color: var(--text-mid); }
  .role-badge {
    margin-left: auto; font-size: 11px; font-weight: 700; padding: 4px 10px;
    border-radius: 20px;
  }
  .role-badge.admin { background: var(--pink-pale); color: var(--pink); }
  .role-badge.viewer { background: var(--mint-pale); color: #2A8055; }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    align-items: flex-end; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-sheet {
    background: white; border-radius: 28px 28px 0 0;
    width: 100%; max-width: 430px; padding: 0 0 40px;
    animation: slideUp 0.3s ease;
    max-height: 90vh; overflow-y: auto;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 12px auto 0; }
  .modal-title { font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 900; padding: 20px 24px 0; }
  .modal-body { padding: 20px 24px; }
  .modal-row { margin-bottom: 16px; }
  .modal-row label { display: block; font-size: 12px; font-weight: 700; color: var(--text-mid); margin-bottom: 8px; text-transform: uppercase; }
  .modal-row input, .modal-row select, .modal-row textarea {
    width: 100%; padding: 14px; border: 2px solid #eee; border-radius: var(--radius-sm);
    font-size: 15px; font-family: inherit; outline: none; transition: border-color 0.2s;
  }
  .modal-row input:focus, .modal-row select:focus, .modal-row textarea:focus { border-color: var(--pink); }
  .modal-row textarea { min-height: 80px; resize: none; }
  .type-pills { display: flex; flex-wrap: wrap; gap: 8px; }
  .type-pill {
    padding: 8px 16px; border: 2px solid #eee; border-radius: 20px;
    font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    background: white; color: var(--text-mid);
  }
  .type-pill.active { border-color: var(--pink); background: var(--pink-pale); color: var(--pink); }
  .timer-display {
    text-align: center; padding: 20px 0;
  }
  .timer-display .timer-num {
    font-family: 'Nunito', sans-serif; font-size: 56px; font-weight: 900; color: var(--text-dark);
  }
  .timer-display .timer-label { font-size: 13px; color: var(--text-mid); margin-top: 4px; }
  .btn-timer {
    padding: 16px 32px; border: none; border-radius: var(--radius); font-size: 17px;
    font-weight: 800; cursor: pointer; font-family: 'Nunito', sans-serif;
    transition: all 0.2s; margin: 0 auto; display: block;
  }
  .btn-timer.start { background: linear-gradient(135deg, var(--blue), #6BA8F5); color: white; }
  .btn-timer.stop { background: linear-gradient(135deg, var(--pink), #FF6B9D); color: white; }
  .btn-save {
    width: 100%; padding: 16px; background: linear-gradient(135deg, var(--pink), var(--purple));
    border: none; border-radius: var(--radius-sm); color: white; font-size: 16px;
    font-weight: 800; cursor: pointer; font-family: 'Nunito', sans-serif; margin-top: 8px;
  }
  .btn-cancel {
    width: 100%; padding: 14px; background: none; border: 2px solid #eee;
    border-radius: var(--radius-sm); color: var(--text-mid); font-size: 15px;
    font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 8px;
  }

  /* Sleep Active Indicator */
  .sleep-active-bar {
    display: none; background: linear-gradient(135deg, var(--blue-pale), #D6EEFF);
    margin: 12px 16px; border-radius: var(--radius-sm); padding: 12px 16px;
    border: 1px solid var(--blue); align-items: center; gap: 12px;
  }
  .sleep-active-bar.show { display: flex; }
  .sleep-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--blue); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }
  .sleep-active-text { flex: 1; font-size: 13px; font-weight: 700; color: #2060A0; }
  .btn-stop-sleep {
    padding: 8px 14px; background: var(--blue); border: none; border-radius: 10px;
    color: white; font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit;
  }

  /* Toast */
  .toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: rgba(45,45,45,0.92); color: white; padding: 12px 24px;
    border-radius: 24px; font-size: 14px; font-weight: 600; z-index: 1000;
    opacity: 0; transition: all 0.3s; white-space: nowrap;
    backdrop-filter: blur(10px);
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ ANALYSIS FEEDBACK â”€â”€ */
  .feedback-card {
    margin: 8px 16px 0;
    border-radius: var(--radius);
    padding: 16px 18px;
    box-shadow: var(--card-shadow);
    animation: fadeInUp 0.4s ease;
  }
  .feedback-card.good { background: linear-gradient(135deg, #F0FBF6, #D8F5E9); border-left: 4px solid #3DBE8A; }
  .feedback-card.warn { background: linear-gradient(135deg, #FFFBEC, #FFF3CC); border-left: 4px solid #FFD93D; }
  .feedback-card.info { background: linear-gradient(135deg, #EBF5FF, #D6EEFF); border-left: 4px solid var(--blue); }
  .feedback-title { font-size: 13px; font-weight: 800; margin-bottom: 6px; }
  .feedback-card.good .feedback-title { color: #2A8055; }
  .feedback-card.warn .feedback-title { color: #B8860B; }
  .feedback-card.info .feedback-title { color: #2060A0; }
  .feedback-rows { display: flex; flex-direction: column; gap: 5px; }
  .feedback-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .feedback-row .fb-label { color: var(--text-mid); min-width: 60px; }
  .feedback-row .fb-value { font-weight: 700; }
  .feedback-row .fb-status { margin-left: auto; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 10px; }
  .fb-status.ok { background: var(--mint-light); color: #2A8055; }
  .fb-status.low { background: #FFF3CC; color: #B8860B; }
  .fb-status.high { background: #FFE0E0; color: #CC3333; }
  .insight-box {
    margin: 8px 16px 0;
    background: linear-gradient(135deg, var(--pink-pale), var(--purple-pale));
    border-radius: var(--radius); padding: 14px 18px;
    box-shadow: var(--card-shadow);
  }
  .insight-box .insight-title { font-size: 13px; font-weight: 800; color: var(--pink); margin-bottom: 8px; }
  .insight-item { font-size: 13px; color: var(--text-mid); padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .insight-item:last-child { border-bottom: none; }
  .insight-item strong { color: var(--text-dark); }

  /* â”€â”€ FOOD PAGE â”€â”€ */
  .food-container { padding: 0 16px 20px; }
  .food-card {
    background: white; border-radius: var(--radius); padding: 20px;
    box-shadow: var(--card-shadow); margin-bottom: 16px;
  }
  .food-card h3 { font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 800; margin-bottom: 14px; }
  .food-search-wrap { position: relative; margin-bottom: 14px; }
  .food-search-wrap input {
    width: 100%; padding: 12px 16px 12px 42px; border: 2px solid var(--pink-light);
    border-radius: var(--radius-sm); font-size: 15px; font-family: inherit; outline: none;
    background: white; transition: border-color 0.2s;
  }
  .food-search-wrap input:focus { border-color: var(--pink); }
  .food-search-wrap .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 18px; }
  .food-search-results {
    background: white; border: 2px solid var(--pink-light); border-radius: var(--radius-sm);
    max-height: 200px; overflow-y: auto; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  .food-search-results.show { display: block; }
  .food-result-item {
    padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f5f5f5;
    display: flex; align-items: center; gap: 10px; font-size: 14px;
    transition: background 0.15s;
  }
  .food-result-item:hover { background: var(--pink-pale); }
  .food-result-item .f-emoji { font-size: 20px; }
  .food-result-item .f-name { font-weight: 600; }
  .food-result-item .f-cat { font-size: 11px; color: var(--text-light); }
  .category-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .cat-pill {
    padding: 6px 14px; border: 2px solid #eee; border-radius: 20px;
    font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    background: white; color: var(--text-mid);
  }
  .cat-pill.active { border-color: var(--pink); background: var(--pink-pale); color: var(--pink); }
  .food-log-form { display: flex; flex-direction: column; gap: 12px; }
  .food-reaction-pills { display: flex; gap: 8px; flex-wrap: wrap; }
  .reaction-pill {
    padding: 8px 14px; border: 2px solid #eee; border-radius: 20px;
    font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    background: white;
  }
  .reaction-pill.active.good { border-color: #3DBE8A; background: var(--mint-pale); color: #2A8055; }
  .reaction-pill.active.warn { border-color: #FFD93D; background: var(--yellow-pale); color: #B8860B; }
  .reaction-pill.active.bad { border-color: #FF6B6B; background: #FFF0F0; color: #CC3333; }
  .reaction-pill.active.reject { border-color: var(--text-light); background: #f5f5f5; color: var(--text-mid); }
  .btn-add-food {
    width: 100%; padding: 14px; background: linear-gradient(135deg, #FFB347, #FF8FAB);
    border: none; border-radius: var(--radius-sm); color: white; font-size: 15px;
    font-weight: 800; cursor: pointer; font-family: 'Nunito', sans-serif; margin-top: 4px;
  }
  .food-tabs { display: flex; gap: 0; margin-bottom: 16px; border-radius: var(--radius-sm); overflow: hidden; border: 2px solid var(--pink-light); }
  .food-tab {
    flex: 1; padding: 10px; border: none; background: white; font-size: 12px;
    font-weight: 700; cursor: pointer; transition: all 0.2s; color: var(--text-mid);
    font-family: inherit;
  }
  .food-tab.active { background: var(--pink); color: white; }
  .food-item-list { display: flex; flex-direction: column; gap: 10px; }
  .food-item {
    display: flex; align-items: center; gap: 12px; padding: 12px;
    background: var(--bg); border-radius: var(--radius-sm);
    border: 1px solid rgba(0,0,0,0.05);
  }
  .food-item .fi-emoji { font-size: 24px; flex-shrink: 0; }
  .food-item .fi-info { flex: 1; }
  .food-item .fi-name { font-size: 14px; font-weight: 700; }
  .food-item .fi-detail { font-size: 12px; color: var(--text-mid); margin-top: 2px; }
  .food-item .fi-date { font-size: 11px; color: var(--text-light); margin-top: 2px; }
  .food-item .fi-badge {
    font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; flex-shrink: 0;
  }
  .fi-badge.good { background: var(--mint-light); color: #2A8055; }
  .fi-badge.warn { background: var(--yellow-pale); color: #B8860B; }
  .fi-badge.bad { background: #FFE0E0; color: #CC3333; }
  .fi-badge.reject { background: #f0f0f0; color: var(--text-mid); }
  .fi-badge.todo { background: var(--blue-pale); color: #2060A0; }
  .food-del-btn {
    background: none; border: none; cursor: pointer; font-size: 14px;
    color: var(--text-light); padding: 4px; border-radius: 8px; flex-shrink: 0;
  }
  .empty-food { text-align: center; padding: 30px 20px; color: var(--text-light); font-size: 14px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--pink-light); border-radius: 2px; }

  /* Sleep timer in modal */
  .sleep-timer-wrap { text-align: center; padding: 8px 0 16px; }

  /* Loading */
  .loading-spinner {
    width: 24px; height: 24px; border: 3px solid var(--pink-light);
    border-top-color: var(--pink); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 20px auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="logo">ğŸ¼</div>
  <h1>ì•„ê¸°ì¼ê¸°</h1>
  <p>ì†Œì¤‘í•œ ìˆœê°„ì„ ê¸°ë¡í•´ìš”</p>
</div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-emoji">ğŸ‘¶</div>
    <h2>ì•„ê¸°ì¼ê¸°ì— ì˜¤ì‹  ê²ƒì„<br>í™˜ì˜í•´ìš”!</h2>
    <p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´<br>ê°€ì¡±ê³¼ í•¨ê»˜ ê¸°ë¡ì„ ê³µìœ í•  ìˆ˜ ìˆì–´ìš”</p>
    <button class="btn-google" onclick="signInWithGoogle()">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Googleë¡œ ì‹œì‘í•˜ê¸°
    </button>
    <button class="btn-cancel" style="margin-top:12px;" onclick="skipAuth()">ë‚˜ì¤‘ì— ë¡œê·¸ì¸í•˜ê¸°</button>
  </div>
</div>

<!-- ONBOARDING -->
<div id="onboarding">
  <div class="onboard-header">
    <div class="emoji">ğŸ‘¶</div>
    <h2>ì•„ê¸° ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h2>
    <p>ì„±ì¥ ì°¨íŠ¸ì™€ ë°œë‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ì— ì‚¬ìš©ë¼ìš”</p>
  </div>
  <div class="onboard-body">
    <div class="form-group">
      <label>ì•„ê¸° ì´ë¦„ (ë‹‰ë„¤ì„ë„ OK)</label>
      <input type="text" id="ob-name" placeholder="ì˜ˆ: í•˜ëŠ˜ì´, ìš°ë¦¬ ì•„ê¸°" maxlength="20">
    </div>
    <div class="form-group">
      <label>ìƒë…„ì›”ì¼</label>
      <input type="date" id="ob-birth" max="">
    </div>
    <div class="form-group">
      <label>ì„±ë³„</label>
      <div class="gender-row">
        <button class="gender-btn" id="btn-boy" onclick="selectGender('boy')">
          ğŸ‘¦ <span>ë‚¨ì•„</span>
        </button>
        <button class="gender-btn" id="btn-girl" onclick="selectGender('girl')">
          ğŸ‘§ <span>ì—¬ì•„</span>
        </button>
      </div>
    </div>
    <div class="form-group">
      <label>ì¶œìƒ ì‹œ ëª¸ë¬´ê²Œ</label>
      <input type="number" id="ob-birth-weight" placeholder="ì˜ˆ: 3.2" step="0.01" min="0.5" max="6"> <span style="font-size:13px;color:var(--text-mid);">kg</span>
    </div>
    <div class="form-group">
      <label>ì¶œìƒ ì‹œ í‚¤</label>
      <input type="number" id="ob-birth-height" placeholder="ì˜ˆ: 50" step="0.1" min="30" max="70"> <span style="font-size:13px;color:var(--text-mid);">cm</span>
    </div>
    <div class="form-group">
      <label>ì¡°ì‚°ì•„ ì—¬ë¶€</label>
      <div class="preterm-row">
        <label class="toggle-switch">
          <input type="checkbox" id="ob-preterm" onchange="togglePreterm()">
          <span class="toggle-slider"></span>
        </label>
        <span style="font-size:14px;color:var(--text-mid);">ì˜ˆì •ì¼ë³´ë‹¤ ì¼ì° íƒœì–´ë‚¬ì–´ìš”</span>
      </div>
    </div>
    <div class="form-group" id="due-date-group" style="display:none;">
      <label>ì˜ˆì •ì¼ (ì›ë˜ ì¶œì‚° ì˜ˆì •ì¼)</label>
      <input type="date" id="ob-due-date">
    </div>
    <button class="btn-primary" onclick="saveOnboarding()">ğŸ¼ ì‹œì‘í•˜ê¸°!</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- HOME PAGE -->
  <div class="page active" id="page-home">
    <div class="app-header">
      <div class="header-top">
        <div class="baby-info">
          <h1 id="header-baby-name">ì•„ê¸°ì¼ê¸° ğŸ¼</h1>
          <p id="header-baby-age">íƒœì–´ë‚œ ì§€ 0ì¼ì§¸</p>
        </div>
        <div class="header-avatar" onclick="goToFamily()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      </div>
      <div class="last-feed-card">
        <div>
          <div class="lf-label">ë§ˆì§€ë§‰ ìˆ˜ìœ </div>
          <div class="lf-value" id="last-feed-time">-</div>
        </div>
        <div style="text-align:right;">
          <div class="lf-label">ë‹¤ìŒ ìˆ˜ìœ ê¹Œì§€</div>
          <div class="lf-value" id="next-feed-time">-</div>
          <div class="lf-sub">ì•½ 3ì‹œê°„ ê°„ê²© ê¸°ì¤€</div>
        </div>
      </div>
    </div>

    <div class="sleep-active-bar" id="sleep-active-bar">
      <div class="sleep-dot"></div>
      <div class="sleep-active-text">ğŸ’¤ ìˆ˜ë©´ ì¤‘... <span id="sleep-elapsed">00:00</span></div>
      <button class="btn-stop-sleep" onclick="stopSleep()">ì¼ì–´ë‚¬ì–´ìš”</button>
    </div>

    <div class="section-title">ì˜¤ëŠ˜ì˜ ê¸°ë¡</div>
    <div class="summary-row">
      <div class="summary-card pink">
        <div class="s-num" id="sum-feed">0</div>
        <div class="s-unit">íšŒ</div>
        <div class="s-label">ğŸ¼ ìˆ˜ìœ </div>
      </div>
      <div class="summary-card blue">
        <div class="s-num" id="sum-sleep">0</div>
        <div class="s-unit">ì‹œê°„</div>
        <div class="s-label">ğŸ˜´ ìˆ˜ë©´</div>
      </div>
      <div class="summary-card mint">
        <div class="s-num" id="sum-diaper">0</div>
        <div class="s-unit">íšŒ</div>
        <div class="s-label">ğŸ’§ ê¸°ì €ê·€</div>
      </div>
    </div>
    <div class="summary-row" style="margin-top:8px;">
      <div class="summary-card" style="background:linear-gradient(135deg,#FFF8F0,#FFE8CC);">
        <div class="s-num" style="color:#FFB347;" id="sum-food">0</div>
        <div class="s-unit">íšŒ</div>
        <div class="s-label">ğŸ¥£ ì´ìœ ì‹</div>
      </div>
      <div class="summary-card" style="background:linear-gradient(135deg,#FFF0F4,#FFE4EC);">
        <div class="s-num" style="color:#FF8FAB;" id="sum-temp">-</div>
        <div class="s-unit">Â°C</div>
        <div class="s-label">ğŸŒ¡ï¸ ì²´ì˜¨</div>
      </div>
      <div class="summary-card" style="background:linear-gradient(135deg,#F3F0FF,#E8E0FF);">
        <div class="s-num" style="color:#C9B8FF;" id="sum-bath">0</div>
        <div class="s-unit">íšŒ</div>
        <div class="s-label">ğŸ› ëª©ìš•</div>
      </div>
    </div>

    <!-- ANALYSIS FEEDBACK -->
    <div id="feedback-section"></div>

    <div class="section-title" style="margin-top:8px;">ë¹ ë¥¸ ê¸°ë¡</div>
    <div class="quick-grid">
      <button class="quick-btn feed" onclick="openModal('feed')">
        <span class="q-emoji">ğŸ¼</span>
        <span class="q-label">ìˆ˜ìœ </span>
      </button>
      <button class="quick-btn sleep" onclick="openModal('sleep')">
        <span class="q-emoji">ğŸ˜´</span>
        <span class="q-label">ìˆ˜ë©´</span>
      </button>
      <button class="quick-btn diaper" onclick="openModal('diaper')">
        <span class="q-emoji">ğŸ’§</span>
        <span class="q-label">ê¸°ì €ê·€</span>
      </button>
      <button class="quick-btn bath" onclick="openModal('bath')">
        <span class="q-emoji">ğŸ›</span>
        <span class="q-label">ëª©ìš•</span>
      </button>
      <button class="quick-btn temp" onclick="openModal('temp')">
        <span class="q-emoji">ğŸŒ¡ï¸</span>
        <span class="q-label">ì²´ì˜¨</span>
      </button>
      <button class="quick-btn memo" onclick="openModal('memo')">
        <span class="q-emoji">ğŸ“</span>
        <span class="q-label">ë©”ëª¨</span>
      </button>
    </div>

    <div class="section-title" style="margin-top:8px;">ì˜¤ëŠ˜ì˜ íƒ€ì„ë¼ì¸</div>
    <div class="timeline" id="timeline-list">
      <div class="empty-timeline">
        <div class="et-emoji">ğŸŒ™</div>
        <p>ì•„ì§ ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ì–´ìš”<br>ìœ„ì—ì„œ ê¸°ë¡ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
      </div>
    </div>
  </div>

  <!-- STATS PAGE -->
  <div class="page" id="page-stats">
    <div class="app-header" style="padding-bottom:20px;">
      <h1 style="font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:white;">ğŸ“Š í†µê³„</h1>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin-top:4px;">ìµœê·¼ 7ì¼ ê¸°ë¡ ë¶„ì„</p>
    </div>
    <div class="stats-container" style="margin-top:20px;">
      <div class="chart-card">
        <div class="chart-title">ğŸ¼ ì¼ì¼ ìˆ˜ìœ  íšŸìˆ˜ (7ì¼)</div>
        <div class="bar-chart" id="feed-bar-chart"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ˜´ ì¼ì¼ ìˆ˜ë©´ ì‹œê°„ (7ì¼)</div>
        <div class="bar-chart" id="sleep-bar-chart"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ì˜¤ëŠ˜ í•˜ë£¨ ê¸°ë¡ ë¶„í¬</div>
        <div class="pie-container">
          <canvas id="pieChart" width="120" height="120"></canvas>
          <div class="pie-legend" id="pie-legend"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- GROWTH PAGE -->
  <div class="page" id="page-growth">
    <div class="app-header" style="padding-bottom:20px;">
      <h1 style="font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:white;">ğŸ“ ì„±ì¥ ê¸°ë¡</h1>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin-top:4px;">WHO 2006 ì„±ì¥ ê¸°ì¤€ (ìºë‚˜ë‹¤ ê³µì‹)</p>
    </div>
    <div class="growth-container" style="margin-top:20px;">
      <div class="growth-card">
        <div class="chart-title">ì˜¤ëŠ˜ ì¸¡ì •ê°’ ì…ë ¥</div>
        <div class="growth-inputs">
          <div class="g-input-group">
            <label>ëª¸ë¬´ê²Œ (kg)</label>
            <input type="number" id="g-weight" placeholder="ì˜ˆ: 5.2" step="0.01" min="1" max="30">
          </div>
          <div class="g-input-group">
            <label>í‚¤ (cm)</label>
            <input type="number" id="g-height" placeholder="ì˜ˆ: 58" step="0.1" min="30" max="130">
          </div>
        </div>
        <div class="growth-inputs" style="margin-top:0;">
          <div class="g-input-group">
            <label>ë¨¸ë¦¬ë‘˜ë ˆ (cm)</label>
            <input type="number" id="g-head" placeholder="ì˜ˆ: 38" step="0.1" min="20" max="60">
          </div>
          <div class="g-input-group">
            <label>ì¸¡ì • ë‚ ì§œ</label>
            <input type="date" id="g-date">
          </div>
        </div>
        <button class="btn-save-growth" onclick="saveGrowth()">ì €ì¥í•˜ê¸°</button>
      </div>
      <div class="growth-card">
        <div class="chart-title">ğŸ“ˆ ì„±ì¥ ì¶”ì´</div>
        <canvas id="growthChart" height="200"></canvas>
        <div class="growth-percentile" id="growth-percentile"></div>
      </div>
      <div class="growth-card">
        <div class="chart-title">ğŸ’‰ ì˜ˆë°©ì ‘ì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
        <div class="vaccine-list" id="vaccine-list"></div>
      </div>
    </div>
  </div>

  <!-- FAMILY PAGE -->
  <div class="page" id="page-family">
    <div class="app-header" style="padding-bottom:20px;">
      <h1 style="font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:white;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ê³µìœ </h1>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin-top:4px;">í•¨ê»˜ ê¸°ë¡í•´ìš”</p>
    </div>
    <div class="family-container" style="margin-top:20px;">
      <div class="family-card">
        <h3>ğŸ“ ì´ˆëŒ€ ë§í¬</h3>
        <div class="invite-box" id="invite-link">ë¡œê·¸ì¸ í›„ ì´ˆëŒ€ ë§í¬ê°€ ìƒì„±ë©ë‹ˆë‹¤</div>
        <button class="btn-share" onclick="shareLink()">
          ğŸ“¤ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ê¸°
        </button>
      </div>
      <div class="family-card">
        <h3>ğŸ‘¥ ê°€ì¡± êµ¬ì„±ì›</h3>
        <div class="member-list" id="member-list">
          <div class="member-item">
            <div class="member-avatar">ğŸ‘¤</div>
            <div class="member-info">
              <div class="m-name" id="my-member-name">ë‚˜</div>
              <div class="m-role">ì•„ê¸° ë“±ë¡ì</div>
            </div>
            <span class="role-badge admin">ê´€ë¦¬ì</span>
          </div>
        </div>
      </div>
      <div class="family-card">
        <h3>ğŸ“‹ ìµœê·¼ 48ì‹œê°„ ê³µë™ ê¸°ë¡</h3>
        <div id="shared-feed">
          <div style="text-align:center;padding:20px;color:var(--text-light);font-size:14px;">ë¡œê·¸ì¸ í›„ ê°€ì¡±ì˜ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOD PAGE -->
  <div class="page" id="page-food">
    <div class="app-header" style="padding-bottom:20px;">
      <h1 style="font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:white;">ğŸ¥£ ì´ìœ ì‹ ê¸°ë¡</h1>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin-top:4px;">ë¨¹ì€ ìŒì‹, ë°˜ì‘, ê³„íšì„ ê´€ë¦¬í•´ìš”</p>
    </div>
    <div class="food-container" style="margin-top:20px;">

      <!-- ìŒì‹ ì¶”ê°€ ì¹´ë“œ -->
      <div class="food-card">
        <h3>ğŸ½ï¸ ìŒì‹ ê¸°ë¡ ì¶”ê°€</h3>

        <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
        <div class="category-pills">
          <button class="cat-pill active" onclick="selectFoodCat(this,'ì „ì²´')">ì „ì²´</button>
          <button class="cat-pill" onclick="selectFoodCat(this,'ì±„ì†Œ')">ğŸ¥¦ ì±„ì†Œ</button>
          <button class="cat-pill" onclick="selectFoodCat(this,'ê³¼ì¼')">ğŸ ê³¼ì¼</button>
          <button class="cat-pill" onclick="selectFoodCat(this,'ê³¡ë¥˜')">ğŸŒ¾ ê³¡ë¥˜</button>
          <button class="cat-pill" onclick="selectFoodCat(this,'ë‹¨ë°±ì§ˆ')">ğŸ¥š ë‹¨ë°±ì§ˆ</button>
          <button class="cat-pill" onclick="selectFoodCat(this,'ìœ ì œí’ˆ')">ğŸ¥› ìœ ì œí’ˆ</button>
        </div>

        <!-- ìŒì‹ ê²€ìƒ‰ -->
        <div class="food-search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="food-search-input" placeholder="ìŒì‹ ì´ë¦„ ê²€ìƒ‰ ë˜ëŠ” ì§ì ‘ ì…ë ¥" oninput="searchFood(this.value)" autocomplete="off">
          <div class="food-search-results" id="food-search-results"></div>
        </div>

        <div class="food-log-form">
          <!-- ì„ íƒëœ ìŒì‹ -->
          <div style="padding:12px;background:var(--pink-pale);border-radius:var(--radius-sm);font-size:14px;font-weight:700;color:var(--pink);min-height:44px;display:flex;align-items:center;">
            <span id="selected-food-display">ğŸ‘† ìœ„ì—ì„œ ìŒì‹ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</span>
          </div>

          <!-- ë‚ ì§œ -->
          <div>
            <label style="font-size:12px;font-weight:700;color:var(--text-mid);display:block;margin-bottom:6px;">ë‚ ì§œ</label>
            <input type="date" id="food-date" style="width:100%;padding:12px 14px;border:2px solid var(--pink-light);border-radius:var(--radius-sm);font-size:15px;font-family:inherit;outline:none;">
          </div>

          <!-- ì–‘ -->
          <div>
            <label style="font-size:12px;font-weight:700;color:var(--text-mid);display:block;margin-bottom:6px;">ë¨¹ì€ ì–‘ (ì„ íƒ)</label>
            <input type="text" id="food-amount" placeholder="ì˜ˆ: 2ìŠ¤í‘¼, ë°˜ ê³µê¸°" style="width:100%;padding:12px 14px;border:2px solid var(--pink-light);border-radius:var(--radius-sm);font-size:15px;font-family:inherit;outline:none;">
          </div>

          <!-- ë°˜ì‘ -->
          <div>
            <label style="font-size:12px;font-weight:700;color:var(--text-mid);display:block;margin-bottom:8px;">ì•„ê¸° ë°˜ì‘</label>
            <div class="food-reaction-pills">
              <button class="reaction-pill active good" onclick="selectReaction(this,'ì˜ë¨¹ìŒ')">ğŸ˜‹ ì˜ ë¨¹ìŒ</button>
              <button class="reaction-pill warn" onclick="selectReaction(this,'ë³´í†µ')">ğŸ˜ ë³´í†µ</button>
              <button class="reaction-pill bad" onclick="selectReaction(this,'ì•Œë ˆë¥´ê¸°')">âš ï¸ ì•Œë ˆë¥´ê¸°</button>
              <button class="reaction-pill reject" onclick="selectReaction(this,'ê±°ë¶€')">ğŸ™… ê±°ë¶€</button>
            </div>
          </div>

          <!-- ìƒíƒœ (ë¨¹ì—ˆëŠ”ì§€ / ì˜ˆì •ì¸ì§€) -->
          <div>
            <label style="font-size:12px;font-weight:700;color:var(--text-mid);display:block;margin-bottom:8px;">ìƒíƒœ</label>
            <div class="food-reaction-pills">
              <button class="reaction-pill active good" id="status-ate" onclick="selectStatus('ate')">âœ… ë¨¹ì—ˆì–´ìš”</button>
              <button class="reaction-pill" id="status-todo" onclick="selectStatus('todo')" style="border-color:#93C6F5;color:#2060A0;">ğŸ“‹ ë¨¹ì¼ ì˜ˆì •</button>
            </div>
          </div>

          <!-- ë©”ëª¨ -->
          <div>
            <label style="font-size:12px;font-weight:700;color:var(--text-mid);display:block;margin-bottom:6px;">ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="food-memo" placeholder="ë°˜ì‘ ìƒì„¸, ì¡°ë¦¬ë²• ë“±" style="width:100%;padding:12px 14px;border:2px solid var(--pink-light);border-radius:var(--radius-sm);font-size:14px;font-family:inherit;outline:none;min-height:70px;resize:none;"></textarea>
          </div>

          <button class="btn-add-food" onclick="saveFoodRecord()">ğŸ¥£ ì €ì¥í•˜ê¸°</button>
        </div>
      </div>

      <!-- ìŒì‹ ëª©ë¡ -->
      <div class="food-card">
        <h3>ğŸ“‹ ì´ìœ ì‹ ê¸°ë¡ ëª©ë¡</h3>
        <div class="food-tabs">
          <button class="food-tab active" onclick="switchFoodTab(this,'all')">ì „ì²´</button>
          <button class="food-tab" onclick="switchFoodTab(this,'ate')">ë¨¹ì€ ìŒì‹</button>
          <button class="food-tab" onclick="switchFoodTab(this,'todo')">ë¨¹ì¼ ì˜ˆì •</button>
          <button class="food-tab" onclick="switchFoodTab(this,'reject')">ê±°ë¶€/ì•Œë ˆë¥´ê¸°</button>
        </div>
        <div class="food-item-list" id="food-item-list">
          <div class="empty-food">ğŸ¥£ ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”<br>ìœ„ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
        </div>
      </div>

      <!-- í†µê³„ ìš”ì•½ -->
      <div class="food-card">
        <h3>ğŸ“Š ì´ìœ ì‹ í˜„í™©</h3>
        <div class="summary-row" style="padding:0;margin:0;">
          <div class="summary-card pink">
            <div class="s-num" id="food-ate-count">0</div>
            <div class="s-unit">ê°€ì§€</div>
            <div class="s-label">ë¨¹ì€ ìŒì‹</div>
          </div>
          <div class="summary-card blue">
            <div class="s-num" id="food-todo-count">0</div>
            <div class="s-unit">ê°€ì§€</div>
            <div class="s-label">ë¨¹ì¼ ì˜ˆì •</div>
          </div>
          <div class="summary-card" style="background:white;">
            <div class="s-num" style="color:#CC3333;" id="food-alert-count">0</div>
            <div class="s-unit">ê°€ì§€</div>
            <div class="s-label">ì£¼ì˜ ìŒì‹</div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div><!-- /app -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav" id="bottom-nav" style="display:none;">
  <button class="nav-btn active" onclick="switchPage('home', this)">
    <span class="nav-icon">ğŸ </span>
    <span class="nav-label">í™ˆ</span>
  </button>
  <button class="nav-btn" onclick="switchPage('stats', this)">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">í†µê³„</span>
  </button>
  <button class="nav-btn" onclick="switchPage('food', this)">
    <span class="nav-icon">ğŸ¥£</span>
    <span class="nav-label">ì´ìœ ì‹</span>
  </button>
  <button class="nav-btn" onclick="switchPage('growth', this)">
    <span class="nav-icon">ğŸ“</span>
    <span class="nav-label">ì„±ì¥</span>
  </button>
  <button class="nav-btn" onclick="switchPage('family', this)">
    <span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
    <span class="nav-label">ê°€ì¡±</span>
  </button>
</nav>

<!-- MODALS -->
<!-- Feed Modal -->
<div class="modal-overlay" id="modal-feed" onclick="closeModalOutside(event,'modal-feed')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ¼ ìˆ˜ìœ  ê¸°ë¡</div>
    <div class="modal-body">
      <div class="modal-row">
        <label>ìˆ˜ìœ  ìœ í˜•</label>
        <div class="type-pills">
          <button class="type-pill active" onclick="selectPill(this,'feed-type')">ëª¨ìœ  (ì™¼ìª½)</button>
          <button class="type-pill" onclick="selectPill(this,'feed-type')">ëª¨ìœ  (ì˜¤ë¥¸ìª½)</button>
          <button class="type-pill" onclick="selectPill(this,'feed-type')">ë¶„ìœ </button>
          <button class="type-pill" onclick="selectPill(this,'feed-type')">ì´ìœ ì‹</button>
          <button class="type-pill" onclick="selectPill(this,'feed-type')">í˜¼í•©</button>
        </div>
      </div>
      <div class="modal-row">
        <label>ì–‘ / ì‹œê°„</label>
        <input type="number" id="feed-amount" placeholder="ml ë˜ëŠ” ë¶„ (ì„ íƒì‚¬í•­)">
      </div>
      <div class="modal-row">
        <label>ì‹œì‘ ì‹œê°„</label>
        <input type="datetime-local" id="feed-time">
      </div>
      <div class="modal-row">
        <label>ë©”ëª¨</label>
        <textarea id="feed-memo" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì ì–´ìš” (ì„ íƒì‚¬í•­)"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('feed')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-feed')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Sleep Modal -->
<div class="modal-overlay" id="modal-sleep" onclick="closeModalOutside(event,'modal-sleep')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ˜´ ìˆ˜ë©´ ê¸°ë¡</div>
    <div class="modal-body">
      <div class="sleep-timer-wrap">
        <div class="timer-display">
          <div class="timer-num" id="sleep-timer-display">00:00:00</div>
          <div class="timer-label" id="sleep-timer-label">ìˆ˜ë©´ íƒ€ì´ë¨¸</div>
        </div>
        <button class="btn-timer start" id="sleep-timer-btn" onclick="toggleSleepTimer()">â–¶ ì¬ìš°ê¸° ì‹œì‘</button>
      </div>
      <div class="modal-row" style="margin-top:16px;">
        <label>ë˜ëŠ” ì§ì ‘ ì…ë ¥</label>
      </div>
      <div class="modal-row">
        <label>ìˆ˜ë©´ ì‹œì‘</label>
        <input type="datetime-local" id="sleep-start">
      </div>
      <div class="modal-row">
        <label>ìˆ˜ë©´ ì¢…ë£Œ</label>
        <input type="datetime-local" id="sleep-end">
      </div>
      <div class="modal-row">
        <label>ë©”ëª¨</label>
        <textarea id="sleep-memo" placeholder="ìˆ˜ë©´ í™˜ê²½, íŠ¹ì´ì‚¬í•­ ë“±"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('sleep')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-sleep')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Diaper Modal -->
<div class="modal-overlay" id="modal-diaper" onclick="closeModalOutside(event,'modal-diaper')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’§ ê¸°ì €ê·€ ê¸°ë¡</div>
    <div class="modal-body">
      <div class="modal-row">
        <label>ì¢…ë¥˜</label>
        <div class="type-pills">
          <button class="type-pill active" onclick="selectPill(this,'diaper-type')">ğŸ’§ ì†Œë³€</button>
          <button class="type-pill" onclick="selectPill(this,'diaper-type')">ğŸ’© ëŒ€ë³€</button>
          <button class="type-pill" onclick="selectPill(this,'diaper-type')">ğŸ’§ğŸ’© ë‘˜ ë‹¤</button>
        </div>
      </div>
      <div class="modal-row">
        <label>ì‹œê°„</label>
        <input type="datetime-local" id="diaper-time">
      </div>
      <div class="modal-row">
        <label>ìƒ‰ìƒ/ìƒíƒœ ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
        <textarea id="diaper-memo" placeholder="ìƒ‰ìƒ, ë¬½ê¸° ë“± íŠ¹ì´ì‚¬í•­"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('diaper')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-diaper')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Bath Modal -->
<div class="modal-overlay" id="modal-bath" onclick="closeModalOutside(event,'modal-bath')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ› ëª©ìš• ê¸°ë¡</div>
    <div class="modal-body">
      <div class="modal-row">
        <label>ì‹œê°„</label>
        <input type="datetime-local" id="bath-time">
      </div>
      <div class="modal-row">
        <label>ë©”ëª¨</label>
        <textarea id="bath-memo" placeholder="ë°˜ì‘, íŠ¹ì´ì‚¬í•­ ë“±"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('bath')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-bath')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Temp Modal -->
<div class="modal-overlay" id="modal-temp" onclick="closeModalOutside(event,'modal-temp')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸŒ¡ï¸ ì²´ì˜¨ ê¸°ë¡</div>
    <div class="modal-body">
      <div class="modal-row">
        <label>ì²´ì˜¨ (Â°C)</label>
        <input type="number" id="temp-value" placeholder="ì˜ˆ: 37.2" step="0.1" min="34" max="42">
      </div>
      <div class="modal-row">
        <label>ì¸¡ì • ë°©ë²•</label>
        <div class="type-pills">
          <button class="type-pill active" onclick="selectPill(this,'temp-method')">ê·€</button>
          <button class="type-pill" onclick="selectPill(this,'temp-method')">ê²¨ë“œë‘ì´</button>
          <button class="type-pill" onclick="selectPill(this,'temp-method')">ì§ì¥</button>
          <button class="type-pill" onclick="selectPill(this,'temp-method')">ì´ë§ˆ</button>
        </div>
      </div>
      <div class="modal-row">
        <label>ì‹œê°„</label>
        <input type="datetime-local" id="temp-time">
      </div>
      <div class="modal-row">
        <label>ë©”ëª¨</label>
        <textarea id="temp-memo" placeholder="ì¦ìƒ, ì²˜ì¹˜ ë“±"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('temp')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-temp')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Memo Modal -->
<div class="modal-overlay" id="modal-memo" onclick="closeModalOutside(event,'modal-memo')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“ ë©”ëª¨</div>
    <div class="modal-body">
      <div class="modal-row">
        <label>ì‹œê°„</label>
        <input type="datetime-local" id="memo-time">
      </div>
      <div class="modal-row">
        <label>ë‚´ìš©</label>
        <textarea id="memo-content" placeholder="ììœ ë¡­ê²Œ ê¸°ë¡í•´ìš”" style="min-height:120px;"></textarea>
      </div>
      <button class="btn-save" onclick="saveRecord('memo')">ì €ì¥í•˜ê¸°</button>
      <button class="btn-cancel" onclick="closeModal('modal-memo')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, onSnapshot, setDoc, getDoc, serverTimestamp, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// â”€â”€ YOUR FIREBASE CONFIG â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyBC5y1B592zfv2ROD7HifmdujH-SUkJSFk",
  authDomain: "baby-diary-9f808.firebaseapp.com",
  projectId: "baby-diary-9f808",
  storageBucket: "baby-diary-9f808.firebasestorage.app",
  messagingSenderId: "1037211823707",
  appId: "1:1037211823707:web:a4e974c58d9df3c92c597e",
  measurementId: "G-WMFZ9K4Z0Y"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ì˜¤í”„ë¼ì¸ ì§€ì›
try {
  enableIndexedDbPersistence(db);
} catch(e) {}

// â”€â”€ STATE â”€â”€
let currentUser = null;
let babyInfo = null;
let records = [];
let sleepTimerInterval = null;
let sleepStartTime = null;
let isSleeping = false;
let unsubscribeRecords = null;

// â”€â”€ GLOBAL EXPORTS â”€â”€
window.signInWithGoogle = async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch(e) { showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message); }
};

window.skipAuth = () => {
  document.getElementById('auth-screen').style.display = 'none';
  checkOnboarding();
};

window.signOut = () => signOut(auth);

// â”€â”€ AUTH STATE â”€â”€
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (user) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('my-member-name').textContent = user.displayName || user.email || 'ë‚˜';
    checkOnboarding();
  }
});

// â”€â”€ ONBOARDING â”€â”€
function checkOnboarding() {
  const saved = localStorage.getItem('babyInfo');
  if (saved) {
    babyInfo = JSON.parse(saved);
    showApp();
  } else {
    document.getElementById('onboarding').style.display = 'block';
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('ob-birth').max = today;
  }
}

window.selectGender = (g) => {
  document.getElementById('btn-boy').classList.toggle('selected', g === 'boy');
  document.getElementById('btn-girl').classList.toggle('selected', g === 'girl');
};

window.togglePreterm = () => {
  const checked = document.getElementById('ob-preterm').checked;
  document.getElementById('due-date-group').style.display = checked ? 'block' : 'none';
};

window.saveOnboarding = () => {
  const name = document.getElementById('ob-name').value.trim();
  const birth = document.getElementById('ob-birth').value;
  const gender = document.getElementById('btn-boy').classList.contains('selected') ? 'boy' :
                 document.getElementById('btn-girl').classList.contains('selected') ? 'girl' : null;
  if (!name) { showToast('ì•„ê¸° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!birth) { showToast('ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  if (!gender) { showToast('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  babyInfo = {
    name, birth, gender,
    birthWeight: document.getElementById('ob-birth-weight').value || null,
    birthHeight: document.getElementById('ob-birth-height').value || null,
    preterm: document.getElementById('ob-preterm').checked,
    dueDate: document.getElementById('ob-due-date').value || null,
    createdAt: new Date().toISOString()
  };
  localStorage.setItem('babyInfo', JSON.stringify(babyInfo));
  if (currentUser) saveBabyInfoToFirestore();
  document.getElementById('onboarding').style.display = 'none';
  showApp();
};

async function saveBabyInfoToFirestore() {
  if (!currentUser || !babyInfo) return;
  try {
    await setDoc(doc(db, 'users', currentUser.uid, 'baby', 'info'), babyInfo);
  } catch(e) {}
}

// â”€â”€ SHOW APP â”€â”€
function showApp() {
  document.getElementById('app').style.display = 'block';
  document.getElementById('bottom-nav').style.display = 'flex';
  updateHeader();
  setDefaultTimes();
  loadRecords();
  renderVaccineList();
  generateInviteLink();
}

function updateHeader() {
  if (!babyInfo) return;
  document.getElementById('header-baby-name').textContent = babyInfo.name + ' ğŸ¼';
  const ageText = getAgeText(babyInfo.birth, babyInfo.preterm, babyInfo.dueDate);
  document.getElementById('header-baby-age').textContent = ageText;
}

function getAgeText(birthStr, preterm, dueDate) {
  const birth = new Date(birthStr);
  const now = new Date();
  const diffDays = Math.floor((now - birth) / (1000*60*60*24));
  if (diffDays < 30) return `íƒœì–´ë‚œ ì§€ ${diffDays}ì¼ì§¸ ğŸ’•`;
  const months = Math.floor(diffDays / 30);
  const days = diffDays % 30;
  let txt = `${months}ê°œì›” ${days}ì¼`;
  if (preterm && dueDate) {
    const due = new Date(dueDate);
    const correctedDays = Math.floor((now - due) / (1000*60*60*24));
    if (correctedDays > 0) {
      const cm = Math.floor(correctedDays / 30);
      txt += ` (ìˆ˜ì •ì—°ë ¹ ${cm}ê°œì›”)`;
    }
  }
  return txt + ' ğŸ’•';
}

function setDefaultTimes() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0,16);
  ['feed-time','diaper-time','bath-time','temp-time','memo-time','sleep-start','sleep-end','g-date'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = local;
  });
}

// â”€â”€ RECORDS â”€â”€
function loadRecords() {
  if (currentUser) {
    loadFromFirestore();
  } else {
    loadFromLocal();
    renderTimeline();
    updateSummary();
    renderFeedback();
  }
}

function loadFromLocal() {
  const saved = localStorage.getItem('records');
  records = saved ? JSON.parse(saved) : [];
}

function saveToLocal() {
  localStorage.setItem('records', JSON.stringify(records));
}

async function loadFromFirestore() {
  if (!currentUser) return;
  const babyId = getBabyId();
  const q = query(
    collection(db, 'babies', babyId, 'records'),
    orderBy('time', 'desc')
  );
  if (unsubscribeRecords) unsubscribeRecords();
  unsubscribeRecords = onSnapshot(q, (snap) => {
    records = snap.docs.map(d => ({ id: d.id, ...d.data(), time: d.data().time?.toDate?.()?.toISOString() || d.data().time }));
    renderTimeline();
    updateSummary();
    updateLastFeed();
    renderFeedback();
    renderStats();
    renderSharedFeed();
  });
}

function getBabyId() {
  return currentUser ? currentUser.uid : 'local';
}

window.saveRecord = async (type) => {
  const record = buildRecord(type);
  if (!record) return;
  closeModal('modal-' + type);
  showToast('âœ… ì €ì¥ë˜ì—ˆì–´ìš”!');
  if (currentUser) {
    try {
      const babyId = getBabyId();
      await addDoc(collection(db, 'babies', babyId, 'records'), { ...record, createdBy: currentUser.uid, createdByName: currentUser.displayName || 'ë‚˜' });
    } catch(e) { showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
  } else {
    record.id = Date.now().toString();
    records.unshift(record);
    saveToLocal();
    renderTimeline();
    updateSummary();
    updateLastFeed();
    renderFeedback();
  }
};

function buildRecord(type) {
  const now = new Date().toISOString();
  switch(type) {
    case 'feed': {
      const typeEl = document.querySelector('#modal-feed .type-pill.active');
      const feedType = typeEl ? typeEl.textContent.trim() : 'ëª¨ìœ ';
      const amount = document.getElementById('feed-amount').value;
      const time = document.getElementById('feed-time').value || now;
      const memo = document.getElementById('feed-memo').value;
      return { type:'feed', feedType, amount: amount || null, time: new Date(time).toISOString(), memo, icon:'ğŸ¼', label:'ìˆ˜ìœ ', detail: feedType + (amount ? ` ${amount}ml/ë¶„` : '') };
    }
    case 'sleep': {
      const start = document.getElementById('sleep-start').value;
      const end = document.getElementById('sleep-end').value;
      const memo = document.getElementById('sleep-memo').value;
      if (!start) { showToast('ìˆ˜ë©´ ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return null; }
      const startD = new Date(start), endD = end ? new Date(end) : null;
      const duration = endD ? Math.round((endD-startD)/60000) : null;
      return { type:'sleep', time: startD.toISOString(), endTime: endD?.toISOString()||null, duration, memo, icon:'ğŸ˜´', label:'ìˆ˜ë©´', detail: duration ? `${Math.floor(duration/60)}ì‹œê°„ ${duration%60}ë¶„` : 'ì§„í–‰ì¤‘' };
    }
    case 'diaper': {
      const typeEl = document.querySelector('#modal-diaper .type-pill.active');
      const diaperType = typeEl ? typeEl.textContent.replace(/[ğŸ’§ğŸ’©]/g,'').trim() : 'ì†Œë³€';
      const time = document.getElementById('diaper-time').value || now;
      const memo = document.getElementById('diaper-memo').value;
      return { type:'diaper', diaperType, time: new Date(time).toISOString(), memo, icon: diaperType.includes('ëŒ€ë³€') ? 'ğŸ’©' : 'ğŸ’§', label:'ê¸°ì €ê·€', detail: diaperType };
    }
    case 'bath': {
      const time = document.getElementById('bath-time').value || now;
      const memo = document.getElementById('bath-memo').value;
      return { type:'bath', time: new Date(time).toISOString(), memo, icon:'ğŸ›', label:'ëª©ìš•', detail:'ëª©ìš• ì™„ë£Œ' };
    }
    case 'temp': {
      const val = document.getElementById('temp-value').value;
      if (!val) { showToast('ì²´ì˜¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return null; }
      const methodEl = document.querySelector('#modal-temp .type-pill.active');
      const method = methodEl ? methodEl.textContent : '';
      const time = document.getElementById('temp-time').value || now;
      const memo = document.getElementById('temp-memo').value;
      return { type:'temp', value: parseFloat(val), method, time: new Date(time).toISOString(), memo, icon:'ğŸŒ¡ï¸', label:'ì²´ì˜¨', detail: `${val}Â°C (${method})` };
    }
    case 'memo': {
      const content = document.getElementById('memo-content').value;
      if (!content.trim()) { showToast('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return null; }
      const time = document.getElementById('memo-time').value || now;
      return { type:'memo', content, time: new Date(time).toISOString(), icon:'ğŸ“', label:'ë©”ëª¨', detail: content.slice(0,30) };
    }
  }
}

window.deleteRecord = async (id) => {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  if (currentUser) {
    try {
      await deleteDoc(doc(db, 'babies', getBabyId(), 'records', id));
    } catch(e) {}
  } else {
    records = records.filter(r => r.id !== id);
    saveToLocal();
    renderTimeline();
    updateSummary();
  }
  showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆì–´ìš”');
};

// â”€â”€ RENDER TIMELINE â”€â”€
function renderTimeline() {
  const today = new Date().toDateString();
  const todayStr = new Date().toISOString().split('T')[0];

  // ì¼ë°˜ ê¸°ë¡
  const todayRecords = records.filter(r => new Date(r.time).toDateString() === today);

  // ì´ìœ ì‹ ê¸°ë¡ (ì˜¤ëŠ˜ ë‚ ì§œ, ë¨¹ì€ ê²ƒë§Œ)
  const todayFood = foodRecords
    .filter(r => r.date === todayStr && r.status === 'ate')
    .map(r => ({
      id: r.id,
      type: 'food',
      icon: r.emoji || 'ğŸ¥£',
      label: 'ì´ìœ ì‹',
      detail: r.name + (r.amount ? ' Â· ' + r.amount : ''),
      memo: r.memo,
      time: r.createdAt || (r.date + 'T12:00:00'),
      isFoodRecord: true
    }));

  // í•©ì¹˜ê³  ì‹œê°„ìˆœ ì •ë ¬
  const allRecords = [...todayRecords, ...todayFood]
    .sort((a,b) => new Date(b.time) - new Date(a.time));

  const el = document.getElementById('timeline-list');
  if (allRecords.length === 0) {
    el.innerHTML = `<div class="empty-timeline"><div class="et-emoji">ğŸŒ™</div><p>ì•„ì§ ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ì–´ìš”<br>ìœ„ì—ì„œ ê¸°ë¡ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p></div>`;
    return;
  }
  el.innerHTML = allRecords.map(r => `
    <div class="timeline-item">
      <div class="tl-icon ${r.type}" style="${r.type==='food' ? 'background:linear-gradient(135deg,#FFF8F0,#FFE8CC);' : ''}">${r.icon || 'ğŸ“'}</div>
      <div class="tl-content">
        <div class="tl-title">${r.label || r.type}</div>
        <div class="tl-detail">${r.detail || ''}</div>
        ${r.memo ? `<div class="tl-detail" style="color:var(--text-light);font-size:11px;">ğŸ’¬ ${r.memo}</div>` : ''}
        <div class="tl-time">${formatTime(r.time)}</div>
      </div>
      <div class="tl-actions">
        <button class="tl-del-btn" onclick="${r.isFoodRecord ? `deleteFoodRecord('${r.id}')` : `deleteRecord('${r.id}')`}">âœ•</button>
      </div>
    </div>
  `).join('');
}

function formatTime(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', hour12:true });
}

// â”€â”€ SUMMARY â”€â”€
function updateSummary() {
  const today = new Date().toDateString();
  const todayRecs = records.filter(r => new Date(r.time).toDateString() === today);
  const feedCount = todayRecs.filter(r => r.type === 'feed').length;
  const diaperCount = todayRecs.filter(r => r.type === 'diaper').length;
  const sleepMins = todayRecs.filter(r => r.type === 'sleep' && r.duration).reduce((s,r) => s + r.duration, 0);
  const bathCount = todayRecs.filter(r => r.type === 'bath').length;
  const tempRecs = todayRecs.filter(r => r.type === 'temp');
  const lastTemp = tempRecs.length ? tempRecs[tempRecs.length-1].value : null;
  // ì´ìœ ì‹: foodRecordsì—ì„œ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€
  const todayStr = new Date().toISOString().split('T')[0];
  const foodCount = foodRecords.filter(r => r.date === todayStr && r.status === 'ate').length;

  document.getElementById('sum-feed').textContent = feedCount;
  document.getElementById('sum-sleep').textContent = (sleepMins / 60).toFixed(1);
  document.getElementById('sum-diaper').textContent = diaperCount;
  document.getElementById('sum-food').textContent = foodCount;
  document.getElementById('sum-temp').textContent = lastTemp || '-';
  document.getElementById('sum-bath').textContent = bathCount;
}

function updateLastFeed() {
  const feeds = records.filter(r => r.type === 'feed').sort((a,b) => new Date(b.time)-new Date(a.time));
  if (feeds.length === 0) { document.getElementById('last-feed-time').textContent = '-'; document.getElementById('next-feed-time').textContent = '-'; return; }
  const last = new Date(feeds[0].time);
  const now = new Date();
  const diffMins = Math.floor((now - last) / 60000);
  document.getElementById('last-feed-time').textContent = diffMins < 60 ? `${diffMins}ë¶„ ì „` : `${Math.floor(diffMins/60)}ì‹œê°„ ì „`;
  const nextMins = 180 - diffMins;
  document.getElementById('next-feed-time').textContent = nextMins > 0 ? `${nextMins}ë¶„ í›„` : 'ì§€ê¸ˆ!';
}

// â”€â”€ SLEEP TIMER â”€â”€
window.toggleSleepTimer = () => {
  if (!isSleeping) {
    sleepStartTime = new Date();
    isSleeping = true;
    const local = new Date(sleepStartTime.getTime() - sleepStartTime.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.getElementById('sleep-start').value = local;
    document.getElementById('sleep-timer-btn').className = 'btn-timer stop';
    document.getElementById('sleep-timer-btn').textContent = 'â¹ ì¼ì–´ë‚¬ì–´ìš”';
    document.getElementById('sleep-timer-label').textContent = 'ìˆ˜ë©´ ì¤‘...';
    sleepTimerInterval = setInterval(updateSleepTimer, 1000);
    document.getElementById('sleep-active-bar').classList.add('show');
    closeModal('modal-sleep');
    showToast('ğŸ˜´ ìˆ˜ë©´ ê¸°ë¡ ì‹œì‘!');
  } else {
    stopSleepAndSave();
  }
};

function updateSleepTimer() {
  if (!sleepStartTime) return;
  const elapsed = Math.floor((new Date() - sleepStartTime) / 1000);
  const h = Math.floor(elapsed/3600).toString().padStart(2,'0');
  const m = Math.floor((elapsed%3600)/60).toString().padStart(2,'0');
  const s = (elapsed%60).toString().padStart(2,'0');
  const display = `${h}:${m}:${s}`;
  document.getElementById('sleep-timer-display').textContent = display;
  document.getElementById('sleep-elapsed').textContent = `${m}:${s}`;
}

window.stopSleep = () => stopSleepAndSave();

async function stopSleepAndSave() {
  if (!sleepStartTime) return;
  clearInterval(sleepTimerInterval);
  const endTime = new Date();
  const duration = Math.round((endTime - sleepStartTime) / 60000);
  const record = {
    type:'sleep', time: sleepStartTime.toISOString(), endTime: endTime.toISOString(),
    duration, memo:'', icon:'ğŸ˜´', label:'ìˆ˜ë©´', detail: `${Math.floor(duration/60)}ì‹œê°„ ${duration%60}ë¶„`
  };
  isSleeping = false;
  sleepStartTime = null;
  document.getElementById('sleep-active-bar').classList.remove('show');
  document.getElementById('sleep-timer-btn').className = 'btn-timer start';
  document.getElementById('sleep-timer-btn').textContent = 'â–¶ ì¬ìš°ê¸° ì‹œì‘';
  if (currentUser) {
    await addDoc(collection(db, 'babies', getBabyId(), 'records'), { ...record, createdBy: currentUser.uid, createdByName: currentUser.displayName || 'ë‚˜' });
  } else {
    record.id = Date.now().toString();
    records.unshift(record);
    saveToLocal();
    renderTimeline();
    updateSummary();
  }
  showToast(`ğŸ˜´ ìˆ˜ë©´ ${Math.floor(duration/60)}ì‹œê°„ ${duration%60}ë¶„ ì €ì¥!`);
}

// â”€â”€ STATS â”€â”€
function renderStats() {
  renderBarCharts();
  renderPieChart();
}

function renderBarCharts() {
  const days = getLast7Days();
  renderBarChart('feed-bar-chart', days.map(d => ({
    label: d.label,
    value: records.filter(r => r.type==='feed' && new Date(r.time).toDateString()===d.date).length,
    max: 15
  })), 'pink');
  renderBarChart('sleep-bar-chart', days.map(d => ({
    label: d.label,
    value: +(records.filter(r => r.type==='sleep' && r.duration && new Date(r.time).toDateString()===d.date).reduce((s,r)=>s+r.duration,0)/60).toFixed(1),
    max: 20
  })), 'blue');
}

function getLast7Days() {
  const arr = [];
  for (let i=6; i>=0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    arr.push({ date: d.toDateString(), label: ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()] });
  }
  return arr;
}

function renderBarChart(id, data, color) {
  const el = document.getElementById(id);
  if (!el) return;
  const max = Math.max(...data.map(d=>d.value), 1);
  el.innerHTML = data.map(d => `
    <div class="bar-item">
      <div class="bar-val">${d.value||''}</div>
      <div class="bar ${color}" style="height:${Math.max((d.value/max)*90, d.value?4:2)}px"></div>
      <div class="bar-label">${d.label}</div>
    </div>
  `).join('');
}

function renderPieChart() {
  const today = new Date().toDateString();
  const todayRecs = records.filter(r => new Date(r.time).toDateString() === today);
  const counts = { feed:0, sleep:0, diaper:0, bath:0, temp:0, memo:0 };
  todayRecs.forEach(r => { if(counts[r.type]!==undefined) counts[r.type]++; });
  const labels = { feed:'ìˆ˜ìœ ', sleep:'ìˆ˜ë©´', diaper:'ê¸°ì €ê·€', bath:'ëª©ìš•', temp:'ì²´ì˜¨', memo:'ë©”ëª¨' };
  const colors = { feed:'#FF8FAB', sleep:'#93C6F5', diaper:'#A8E6CF', bath:'#C9B8FF', temp:'#FFD93D', memo:'#FFB347' };
  const canvas = document.getElementById('pieChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  if (total === 0) {
    ctx.clearRect(0,0,120,120);
    ctx.fillStyle = '#eee'; ctx.beginPath(); ctx.arc(60,60,54,0,Math.PI*2); ctx.fill();
    document.getElementById('pie-legend').innerHTML = '<div style="color:var(--text-light);font-size:13px;">ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ì–´ìš”</div>';
    return;
  }
  ctx.clearRect(0,0,120,120);
  let start = -Math.PI/2;
  const legendItems = [];
  Object.entries(counts).forEach(([key, val]) => {
    if (!val) return;
    const slice = (val/total) * Math.PI*2;
    ctx.fillStyle = colors[key];
    ctx.beginPath(); ctx.moveTo(60,60); ctx.arc(60,60,54,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
    legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:${colors[key]}"></div>${labels[key]}: ${val}íšŒ</div>`);
  });
  document.getElementById('pie-legend').innerHTML = legendItems.join('');
}

// â”€â”€ GROWTH â”€â”€
const WHO_WEIGHT_BOYS = [[0,3.3],[1,4.5],[2,5.6],[3,6.4],[4,7.0],[5,7.5],[6,7.9],[9,9.2],[12,10.3],[18,11.5],[24,12.6]];
const WHO_WEIGHT_GIRLS = [[0,3.2],[1,4.2],[2,5.1],[3,5.8],[4,6.4],[5,6.9],[6,7.3],[9,8.6],[12,9.6],[18,10.8],[24,12.0]];

window.saveGrowth = async () => {
  const w = document.getElementById('g-weight').value;
  const h = document.getElementById('g-height').value;
  const head = document.getElementById('g-head').value;
  const date = document.getElementById('g-date').value;
  if (!w && !h) { showToast('ëª¸ë¬´ê²Œ ë˜ëŠ” í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const growth = { weight: w?parseFloat(w):null, height: h?parseFloat(h):null, head: head?parseFloat(head):null, date, createdAt: new Date().toISOString() };
  let growthData = JSON.parse(localStorage.getItem('growthData') || '[]');
  growthData.push(growth);
  localStorage.setItem('growthData', JSON.stringify(growthData));
  if (currentUser) {
    await addDoc(collection(db, 'babies', getBabyId(), 'growth'), growth);
  }
  showToast('ğŸ“ ì„±ì¥ ê¸°ë¡ ì €ì¥!');
  renderGrowthChart();
};

function renderGrowthChart() {
  const data = JSON.parse(localStorage.getItem('growthData') || '[]').sort((a,b)=>new Date(a.date)-new Date(b.date));
  const canvas = document.getElementById('growthChart');
  if (!canvas || data.length === 0) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.offsetWidth || 300, h = 200;
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0,0,w,h);
  if (data.length < 2) return;
  const weights = data.map(d=>d.weight).filter(Boolean);
  if (weights.length < 2) return;
  const minW = Math.min(...weights)*0.8, maxW = Math.max(...weights)*1.1;
  const pad = { t:20, b:30, l:40, r:20 };
  const cw = w-pad.l-pad.r, ch = h-pad.t-pad.b;
  const toX = (i) => pad.l + (i/(data.length-1))*cw;
  const toY = (v) => pad.t + (1-(v-minW)/(maxW-minW))*ch;
  ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
  for (let i=0;i<5;i++) {
    const y = pad.t + (i/4)*ch;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(w-pad.r,y); ctx.stroke();
    const val = (maxW - i/4*(maxW-minW)).toFixed(1);
    ctx.fillStyle = '#aaa'; ctx.font = '10px sans-serif'; ctx.fillText(val, 2, y+4);
  }
  ctx.strokeStyle = '#FF8FAB'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round';
  ctx.beginPath();
  data.forEach((d,i) => { if(!d.weight) return; i===0 ? ctx.moveTo(toX(i),toY(d.weight)) : ctx.lineTo(toX(i),toY(d.weight)); });
  ctx.stroke();
  data.forEach((d,i) => {
    if(!d.weight) return;
    ctx.fillStyle = '#FF8FAB'; ctx.beginPath(); ctx.arc(toX(i),toY(d.weight),5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(toX(i),toY(d.weight),2.5,0,Math.PI*2); ctx.fill();
  });
  document.getElementById('growth-percentile').innerHTML = '<div class="p-badge">WHO ê¸°ì¤€ ì„±ì¥ ì¶”ì´</div>';
}

// â”€â”€ VACCINES â”€â”€
function renderVaccineList() {
  if (!babyInfo) return;
  const birth = new Date(babyInfo.birth);
  const now = new Date();
  const ageMonths = Math.floor((now-birth)/(30*24*60*60*1000));
  const vaccines = [
    { name: 'BCG (ê²°í•µ)', when: 'ìƒí›„ 4ì£¼ ì´ë‚´', dueMonth: 1 },
    { name: 'Bí˜• ê°„ì—¼ 1ì°¨', when: 'ì¶œìƒ ì‹œ', dueMonth: 0 },
    { name: 'Bí˜• ê°„ì—¼ 2ì°¨', when: 'ìƒí›„ 1ê°œì›”', dueMonth: 1 },
    { name: 'DTaP 1ì°¨ (ë””í”„í…Œë¦¬ì•„Â·íŒŒìƒí’Â·ë°±ì¼í•´)', when: 'ìƒí›„ 2ê°œì›”', dueMonth: 2 },
    { name: 'IPV 1ì°¨ (ì†Œì•„ë§ˆë¹„)', when: 'ìƒí›„ 2ê°œì›”', dueMonth: 2 },
    { name: 'Hib 1ì°¨ (ë‡Œìˆ˜ë§‰ì—¼)', when: 'ìƒí›„ 2ê°œì›”', dueMonth: 2 },
    { name: 'PCV 1ì°¨ (íë ´êµ¬ê· )', when: 'ìƒí›„ 2ê°œì›”', dueMonth: 2 },
    { name: 'DTaP 2ì°¨', when: 'ìƒí›„ 4ê°œì›”', dueMonth: 4 },
    { name: 'IPV 2ì°¨', when: 'ìƒí›„ 4ê°œì›”', dueMonth: 4 },
    { name: 'Hib 2ì°¨', when: 'ìƒí›„ 4ê°œì›”', dueMonth: 4 },
    { name: 'PCV 2ì°¨', when: 'ìƒí›„ 4ê°œì›”', dueMonth: 4 },
    { name: 'DTaP 3ì°¨', when: 'ìƒí›„ 6ê°œì›”', dueMonth: 6 },
    { name: 'Bí˜• ê°„ì—¼ 3ì°¨', when: 'ìƒí›„ 6ê°œì›”', dueMonth: 6 },
    { name: 'Hib 3ì°¨', when: 'ìƒí›„ 6ê°œì›”', dueMonth: 6 },
    { name: 'PCV 3ì°¨', when: 'ìƒí›„ 6ê°œì›”', dueMonth: 6 },
    { name: 'MMR (í™ì—­Â·ë³¼ê±°ë¦¬Â·í’ì§„)', when: 'ìƒí›„ 12ê°œì›”', dueMonth: 12 },
    { name: 'ìˆ˜ë‘', when: 'ìƒí›„ 12ê°œì›”', dueMonth: 12 },
    { name: 'Aí˜• ê°„ì—¼ 1ì°¨', when: 'ìƒí›„ 12ê°œì›”', dueMonth: 12 },
    { name: 'DTaP 4ì°¨', when: 'ìƒí›„ 15-18ê°œì›”', dueMonth: 15 },
  ];
  const savedChecks = JSON.parse(localStorage.getItem('vaccineChecks') || '{}');
  const el = document.getElementById('vaccine-list');
  el.innerHTML = vaccines.map((v,i) => {
    const done = savedChecks[i];
    let badgeClass = 'upcoming', badgeText = 'ì˜ˆì •';
    if (done) { badgeClass = 'done'; badgeText = 'ì™„ë£Œ âœ“'; }
    else if (ageMonths >= v.dueMonth) { badgeClass = 'soon'; badgeText = 'ì ‘ì¢… ì‹œê¸°!'; }
    return `
      <div class="vaccine-item">
        <div class="vaccine-check ${done?'done':''}" onclick="toggleVaccine(${i}, this)"></div>
        <div class="vaccine-info">
          <div class="v-name">${v.name}</div>
          <div class="v-when">${v.when}</div>
        </div>
        <span class="vaccine-due ${badgeClass}">${badgeText}</span>
      </div>
    `;
  }).join('');
}

window.toggleVaccine = (i, el) => {
  const checks = JSON.parse(localStorage.getItem('vaccineChecks') || '{}');
  checks[i] = !checks[i];
  localStorage.setItem('vaccineChecks', JSON.stringify(checks));
  el.classList.toggle('done', checks[i]);
  renderVaccineList();
};

// â”€â”€ FAMILY / INVITE â”€â”€
function generateInviteLink() {
  if (!currentUser) return;
  const link = `${location.origin}${location.pathname}?join=${currentUser.uid}`;
  document.getElementById('invite-link').textContent = link;
}

window.shareLink = () => {
  const link = document.getElementById('invite-link').textContent;
  if (navigator.share) {
    navigator.share({ title: 'ì•„ê¸°ì¼ê¸° ì´ˆëŒ€', text: `${babyInfo?.name||'ì•„ê¸°'} ìœ¡ì•„ ê¸°ë¡ì— ì´ˆëŒ€í•©ë‹ˆë‹¤! ë§í¬ë¥¼ ëˆŒëŸ¬ í•¨ê»˜ ê¸°ë¡í•´ìš” ğŸ¼`, url: link });
  } else {
    navigator.clipboard.writeText(link).then(() => showToast('ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆì–´ìš”!'));
  }
};

function renderSharedFeed() {
  const recent = records.slice(0,10);
  if (recent.length === 0) {
    document.getElementById('shared-feed').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);font-size:14px;">ìµœê·¼ 48ì‹œê°„ ê¸°ë¡ì´ ì—†ì–´ìš”</div>';
    return;
  }
  document.getElementById('shared-feed').innerHTML = recent.map(r => `
    <div class="timeline-item">
      <div class="tl-icon ${r.type}">${r.icon||'ğŸ“'}</div>
      <div class="tl-content">
        <div class="tl-title">${r.label}</div>
        <div class="tl-detail">${r.detail}</div>
        <div class="tl-time">${formatTime(r.time)} Â· ${r.createdByName||'ë‚˜'}</div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ MODAL HELPERS â”€â”€
window.openModal = (type) => {
  setDefaultTimes();
  document.querySelectorAll('.type-pill').forEach(p => {
    if (p.closest('#modal-' + type)) p.classList.remove('active');
  });
  const firstPill = document.querySelector(`#modal-${type} .type-pill`);
  if (firstPill) firstPill.classList.add('active');
  document.getElementById('modal-' + type).classList.add('show');
};

window.closeModal = (id) => {
  document.getElementById(id).classList.remove('show');
};

window.closeModalOutside = (e, id) => {
  if (e.target.id === id) closeModal(id);
};

window.selectPill = (el, group) => {
  el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
};

// â”€â”€ NAVIGATION â”€â”€
window.switchPage = (name, btn) => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'stats') { renderStats(); }
  if (name === 'food') { initFoodPage(); }
  if (name === 'growth') { renderGrowthChart(); renderVaccineList(); }
  if (name === 'family') { generateInviteLink(); renderSharedFeed(); }
};

window.goToFamily = () => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-family').classList.add('active');
  document.querySelectorAll('.nav-btn')[3].classList.add('active');
  generateInviteLink(); renderSharedFeed();
};

// â”€â”€ TOAST â”€â”€
window.showToast = (msg) => {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
};

// â”€â”€ SPLASH â†’ AUTH/APP â”€â”€
setTimeout(() => {
  document.getElementById('splash').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        document.getElementById('auth-screen').style.display = 'flex';
      }
    });
  }, 500);
}, 1800);

// â”€â”€ JOIN INVITE â”€â”€
const urlParams = new URLSearchParams(location.search);
const joinUid = urlParams.get('join');
if (joinUid) localStorage.setItem('sharedBabyUid', joinUid);

// setInterval for last feed update
setInterval(() => { if (records.length) { updateLastFeed(); renderFeedback(); } }, 60000);
function getAgeMonths() {
  if (!babyInfo) return 0;
  const birth = new Date(babyInfo.birth);
  const now = new Date();
  // ìˆ˜ì •ì—°ë ¹ ì ìš©
  if (babyInfo.preterm && babyInfo.dueDate) {
    const due = new Date(babyInfo.dueDate);
    return Math.max(0, Math.floor((now - due) / (30*24*60*60*1000)));
  }
  return Math.floor((now - birth) / (30*24*60*60*1000));
}

// ì›”ë ¹ë³„ ì •ìƒ ë²”ìœ„ ê¸°ì¤€ (WHO + ì†Œì•„ê³¼ ê°€ì´ë“œë¼ì¸)
const NORMS = {
  feed: [
    { max: 1,  min: 8,  maxN: 12, label: 'ì‹ ìƒì•„' },
    { max: 2,  min: 7,  maxN: 10, label: '1~2ê°œì›”' },
    { max: 3,  min: 6,  maxN: 8,  label: '2~3ê°œì›”' },
    { max: 4,  min: 5,  maxN: 8,  label: '3~4ê°œì›”' },
    { max: 6,  min: 5,  maxN: 7,  label: '4~6ê°œì›”' },
    { max: 9,  min: 4,  maxN: 6,  label: '6~9ê°œì›”' },
    { max: 12, min: 3,  maxN: 5,  label: '9~12ê°œì›”' },
    { max: 24, min: 3,  maxN: 5,  label: '12ê°œì›” ì´ìƒ' },
  ],
  sleep: [ // ì´ ìˆ˜ë©´ ì‹œê°„(ì‹œê°„)
    { max: 1,  min: 14, maxN: 17, label: 'ì‹ ìƒì•„' },
    { max: 3,  min: 14, maxN: 17, label: '1~3ê°œì›”' },
    { max: 6,  min: 12, maxN: 16, label: '3~6ê°œì›”' },
    { max: 9,  min: 12, maxN: 15, label: '6~9ê°œì›”' },
    { max: 12, min: 11, maxN: 14, label: '9~12ê°œì›”' },
    { max: 24, min: 11, maxN: 14, label: '12ê°œì›” ì´ìƒ' },
  ],
  diaper: [ // ê¸°ì €ê·€ ì†Œë³€ íšŸìˆ˜
    { max: 2,  min: 6,  maxN: 12, label: 'ì‹ ìƒì•„' },
    { max: 6,  min: 6,  maxN: 10, label: '~6ê°œì›”' },
    { max: 24, min: 4,  maxN: 8,  label: '6ê°œì›” ì´ìƒ' },
  ]
};

function getNorm(type, ageMonths) {
  const list = NORMS[type];
  for (const n of list) {
    if (ageMonths < n.max) return n;
  }
  return list[list.length - 1];
}

function renderFeedback() {
  const el = document.getElementById('feedback-section');
  if (!el || !babyInfo) return;
  const ageMonths = getAgeMonths();
  const today = new Date().toDateString();
  const todayStr = new Date().toISOString().split('T')[0];
  const todayRecs = records.filter(r => new Date(r.time).toDateString() === today);
  
  const feedCount = todayRecs.filter(r => r.type === 'feed').length;
  const sleepMins = todayRecs.filter(r => r.type === 'sleep' && r.duration).reduce((s,r) => s+r.duration, 0);
  const sleepHours = +(sleepMins / 60).toFixed(1);
  const diaperCount = todayRecs.filter(r => r.type === 'diaper').length;
  const pooCount = todayRecs.filter(r => r.type === 'diaper' && (r.diaperType||'').includes('ëŒ€ë³€')).length;
  const tempRecs = todayRecs.filter(r => r.type === 'temp');
  const lastTemp = tempRecs.length ? tempRecs[tempRecs.length-1].value : null;
  // ì´ìœ ì‹
  const foodCount = foodRecords.filter(r => r.date === todayStr && r.status === 'ate').length;
  const foodNames = foodRecords.filter(r => r.date === todayStr && r.status === 'ate').map(r => r.name).join(', ');
  const alertFood = foodRecords.filter(r => r.reaction === 'ì•Œë ˆë¥´ê¸°').map(r => r.name);

  const feedNorm = getNorm('feed', ageMonths);
  const sleepNorm = getNorm('sleep', ageMonths);
  const diaperNorm = getNorm('diaper', ageMonths);
  // ì´ìœ ì‹ ê¸°ì¤€: 6ê°œì›” ë¯¸ë§Œ 0~1íšŒ, 6~8ê°œì›” 1~2íšŒ, 8ê°œì›” ì´ìƒ 2~3íšŒ
  const foodNormMin = ageMonths < 6 ? 0 : ageMonths < 8 ? 1 : 2;
  const foodNormMax = ageMonths < 6 ? 1 : ageMonths < 8 ? 2 : 3;

  const getStatus = (val, min, max) => {
    if (val < min) return { cls: 'low', text: 'ë¶€ì¡±' };
    if (val > max) return { cls: 'high', text: 'ë§ìŒ' };
    return { cls: 'ok', text: 'ì •ìƒ âœ“' };
  };

  const feedStatus = getStatus(feedCount, feedNorm.min, feedNorm.maxN);
  const sleepStatus = getStatus(sleepHours, sleepNorm.min, sleepNorm.maxN);
  const diaperStatus = getStatus(diaperCount, diaperNorm.min, diaperNorm.maxN);
  const foodStatus = ageMonths >= 5 ? getStatus(foodCount, foodNormMin, foodNormMax) : null;

  // ì¸ì‚¬ì´íŠ¸ ë©”ì‹œì§€ ìƒì„±
  const insights = [];
  if (feedCount > 0 && feedStatus.cls !== 'ok') {
    if (feedStatus.cls === 'low') insights.push(`ğŸ¼ ìˆ˜ìœ  íšŸìˆ˜ê°€ ì¡°ê¸ˆ <strong>ì ì–´ìš”</strong>. ${ageMonths}ê°œì›” ê¸°ì¤€ í•˜ë£¨ ${feedNorm.min}~${feedNorm.maxN}íšŒê°€ ê¶Œì¥ë¼ìš”.`);
    else insights.push(`ğŸ¼ ìˆ˜ìœ ê°€ <strong>ë§ì€ í¸</strong>ì´ì—ìš”. ìˆ˜ìœ  ê°„ê²©ì„ ì¡°ê¸ˆ ëŠ˜ë ¤ë³´ì„¸ìš”.`);
  }
  if (sleepHours > 0 && sleepStatus.cls !== 'ok') {
    if (sleepStatus.cls === 'low') insights.push(`ğŸ˜´ ìˆ˜ë©´ì´ <strong>ë¶€ì¡±í•´ìš”</strong>. ${ageMonths}ê°œì›” ê¸°ì¤€ í•˜ë£¨ ${sleepNorm.min}~${sleepNorm.maxN}ì‹œê°„ì´ í•„ìš”í•´ìš”.`);
    else insights.push(`ğŸ˜´ ì˜¤ëŠ˜ ìˆ˜ë©´ì´ <strong>ì•„ì£¼ ë§ë„¤ìš”</strong>. ì»¨ë””ì…˜ì´ ì¢‹ì§€ ì•Šì€ì§€ í™•ì¸í•´ë³´ì„¸ìš”.`);
  }
  if (lastTemp !== null) {
    if (lastTemp >= 38.0) insights.push(`ğŸŒ¡ï¸ ì²´ì˜¨ì´ <strong>${lastTemp}Â°C</strong>ë¡œ ë°œì—´ ê¸°ì¤€(38Â°C)ì´ì—ìš”. ì†Œì•„ê³¼ ë°©ë¬¸ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
    else if (lastTemp >= 37.5) insights.push(`ğŸŒ¡ï¸ ì²´ì˜¨ì´ <strong>${lastTemp}Â°C</strong>ë¡œ ë¯¸ì—´ì´ì—ìš”. ìˆ˜ë¶„ ë³´ì¶©ê³¼ ê´€ì°°ì´ í•„ìš”í•´ìš”.`);
    else insights.push(`ğŸŒ¡ï¸ ì²´ì˜¨ <strong>${lastTemp}Â°C</strong> ì •ìƒì´ì—ìš” âœ“`);
  }
  if (pooCount === 0 && ageMonths >= 1 && diaperCount > 0) {
    insights.push(`ğŸ’© ì˜¤ëŠ˜ ëŒ€ë³€ ê¸°ë¡ì´ ì—†ì–´ìš”. 2~3ì¼ ì´ìƒ ì—†ìœ¼ë©´ ì†Œì•„ê³¼ì— ë¬¸ì˜í•´ë³´ì„¸ìš”.`);
  }
  if (ageMonths >= 5 && foodCount > 0) {
    insights.push(`ğŸ¥£ ì˜¤ëŠ˜ ì´ìœ ì‹ <strong>${foodCount}íšŒ</strong> ë¨¹ì—ˆì–´ìš”${foodNames ? ' (' + foodNames + ')' : ''}. ${ageMonths}ê°œì›” ê¸°ì¤€ í•˜ë£¨ ${foodNormMin}~${foodNormMax}íšŒ ê¶Œì¥ì´ì—ìš”.`);
  }
  if (alertFood.length > 0) {
    insights.push(`âš ï¸ ì•Œë ˆë¥´ê¸° ë°˜ì‘ ìŒì‹: <strong>${alertFood.join(', ')}</strong> â€” ë‹¤ì‹œ ì‹œë„ ì‹œ ì£¼ì˜í•˜ì„¸ìš”.`);
  }
  if (feedCount === 0 && sleepHours === 0 && diaperCount === 0) {
    el.innerHTML = '';
    return;
  }

  el.innerHTML = `
    <div class="feedback-card ${feedStatus.cls === 'ok' && sleepStatus.cls === 'ok' && diaperStatus.cls === 'ok' ? 'good' : 'warn'}">
      <div class="feedback-title">ğŸ“‹ ì˜¤ëŠ˜ ${ageMonths}ê°œì›” ê¸°ì¤€ ë¶„ì„</div>
      <div class="feedback-rows">
        <div class="feedback-row">
          <span class="fb-label">ğŸ¼ ìˆ˜ìœ </span>
          <span class="fb-value">${feedCount}íšŒ</span>
          <span style="font-size:11px;color:var(--text-light);">ê¶Œì¥ ${feedNorm.min}~${feedNorm.maxN}íšŒ</span>
          <span class="fb-status ${feedStatus.cls}">${feedStatus.text}</span>
        </div>
        <div class="feedback-row">
          <span class="fb-label">ğŸ˜´ ìˆ˜ë©´</span>
          <span class="fb-value">${sleepHours}ì‹œê°„</span>
          <span style="font-size:11px;color:var(--text-light);">ê¶Œì¥ ${sleepNorm.min}~${sleepNorm.maxN}h</span>
          <span class="fb-status ${sleepStatus.cls}">${sleepStatus.text}</span>
        </div>
        <div class="feedback-row">
          <span class="fb-label">ğŸ’§ ê¸°ì €ê·€</span>
          <span class="fb-value">${diaperCount}íšŒ</span>
          <span style="font-size:11px;color:var(--text-light);">ê¶Œì¥ ${diaperNorm.min}~${diaperNorm.maxN}íšŒ</span>
          <span class="fb-status ${diaperStatus.cls}">${diaperStatus.text}</span>
        </div>
        ${ageMonths >= 5 ? `
        <div class="feedback-row">
          <span class="fb-label">ğŸ¥£ ì´ìœ ì‹</span>
          <span class="fb-value">${foodCount}íšŒ</span>
          <span style="font-size:11px;color:var(--text-light);">ê¶Œì¥ ${foodNormMin}~${foodNormMax}íšŒ</span>
          <span class="fb-status ${foodStatus ? foodStatus.cls : 'ok'}">${foodStatus ? foodStatus.text : 'ì •ìƒ âœ“'}</span>
        </div>` : ''}
        ${lastTemp ? `
        <div class="feedback-row">
          <span class="fb-label">ğŸŒ¡ï¸ ì²´ì˜¨</span>
          <span class="fb-value">${lastTemp}Â°C</span>
          <span style="font-size:11px;color:var(--text-light);">ì •ìƒ 36.5~37.5Â°C</span>
          <span class="fb-status ${lastTemp >= 38 ? 'high' : lastTemp >= 37.5 ? 'low' : 'ok'}">${lastTemp >= 38 ? 'ë°œì—´!' : lastTemp >= 37.5 ? 'ë¯¸ì—´' : 'ì •ìƒ âœ“'}</span>
        </div>` : ''}
      </div>
    </div>
    ${insights.length > 0 ? `
    <div class="insight-box">
      <div class="insight-title">ğŸ’¡ ì˜¤ëŠ˜ì˜ ìœ¡ì•„ ì¸ì‚¬ì´íŠ¸</div>
      ${insights.map(i => `<div class="insight-item">${i}</div>`).join('')}
    </div>` : `
    <div class="insight-box">
      <div class="insight-title">ğŸ’¡ ì˜¤ëŠ˜ì˜ ìœ¡ì•„ ì¸ì‚¬ì´íŠ¸</div>
      <div class="insight-item">âœ¨ ì˜¤ëŠ˜ ëª¨ë“  ê¸°ë¡ì´ <strong>${ageMonths}ê°œì›” ê¸°ì¤€ ì •ìƒ ë²”ìœ„</strong>ì˜ˆìš”! ì˜ í•˜ê³  ê³„ì„¸ìš” ğŸ‘</div>
    </div>`}
  `;
}


// â”€â”€ FOOD DATABASE â”€â”€
const FOOD_DB = [
  // ì±„ì†Œ
  { name:'ë‹¹ê·¼', emoji:'ğŸ¥•', cat:'ì±„ì†Œ', intro:'4~6ê°œì›”' },
  { name:'ê³ êµ¬ë§ˆ', emoji:'ğŸ ', cat:'ì±„ì†Œ', intro:'4~6ê°œì›”' },
  { name:'ê°ì', emoji:'ğŸ¥”', cat:'ì±„ì†Œ', intro:'4~6ê°œì›”' },
  { name:'ì• í˜¸ë°•', emoji:'ğŸ¥’', cat:'ì±„ì†Œ', intro:'4~6ê°œì›”' },
  { name:'ë¸Œë¡œì½œë¦¬', emoji:'ğŸ¥¦', cat:'ì±„ì†Œ', intro:'5~6ê°œì›”' },
  { name:'ì‹œê¸ˆì¹˜', emoji:'ğŸŒ¿', cat:'ì±„ì†Œ', intro:'6ê°œì›” ì´í›„' },
  { name:'ì™„ë‘ì½©', emoji:'ğŸŸ¢', cat:'ì±„ì†Œ', intro:'6~7ê°œì›”' },
  { name:'ì–‘íŒŒ', emoji:'ğŸ§…', cat:'ì±„ì†Œ', intro:'7ê°œì›” ì´í›„' },
  { name:'ë¬´', emoji:'â¬œ', cat:'ì±„ì†Œ', intro:'6ê°œì›” ì´í›„' },
  { name:'ì½œë¦¬í”Œë¼ì›Œ', emoji:'ğŸ¥¦', cat:'ì±„ì†Œ', intro:'6ê°œì›” ì´í›„' },
  { name:'ë¹„íŠ¸', emoji:'ğŸŸ£', cat:'ì±„ì†Œ', intro:'6ê°œì›” ì´í›„' },
  { name:'íŒŒí”„ë¦¬ì¹´', emoji:'ğŸ«‘', cat:'ì±„ì†Œ', intro:'7ê°œì›” ì´í›„' },
  // ê³¼ì¼
  { name:'ì‚¬ê³¼', emoji:'ğŸ', cat:'ê³¼ì¼', intro:'4~6ê°œì›”' },
  { name:'ë°°', emoji:'ğŸ', cat:'ê³¼ì¼', intro:'4~6ê°œì›”' },
  { name:'ë°”ë‚˜ë‚˜', emoji:'ğŸŒ', cat:'ê³¼ì¼', intro:'5~6ê°œì›”' },
  { name:'ì•„ë³´ì¹´ë„', emoji:'ğŸ¥‘', cat:'ê³¼ì¼', intro:'4~6ê°œì›”' },
  { name:'ë³µìˆ­ì•„', emoji:'ğŸ‘', cat:'ê³¼ì¼', intro:'6ê°œì›” ì´í›„' },
  { name:'ë§ê³ ', emoji:'ğŸ¥­', cat:'ê³¼ì¼', intro:'8ê°œì›” ì´í›„' },
  { name:'ë¸”ë£¨ë² ë¦¬', emoji:'ğŸ«', cat:'ê³¼ì¼', intro:'8ê°œì›” ì´í›„' },
  { name:'ë”¸ê¸°', emoji:'ğŸ“', cat:'ê³¼ì¼', intro:'8ê°œì›” ì´í›„' },
  { name:'ìˆ˜ë°•', emoji:'ğŸ‰', cat:'ê³¼ì¼', intro:'8ê°œì›” ì´í›„' },
  { name:'í¬ë„', emoji:'ğŸ‡', cat:'ê³¼ì¼', intro:'10ê°œì›” ì´í›„' },
  // ê³¡ë¥˜
  { name:'ìŒ€ë¯¸ìŒ', emoji:'ğŸš', cat:'ê³¡ë¥˜', intro:'4~6ê°œì›”' },
  { name:'ì˜¤íŠ¸ë°€', emoji:'ğŸŒ¾', cat:'ê³¡ë¥˜', intro:'5~6ê°œì›”' },
  { name:'í˜„ë¯¸', emoji:'ğŸŒ¾', cat:'ê³¡ë¥˜', intro:'6ê°œì›” ì´í›„' },
  { name:'ë³´ë¦¬', emoji:'ğŸŒ¾', cat:'ê³¡ë¥˜', intro:'7ê°œì›” ì´í›„' },
  { name:'ìŒ€ì£½', emoji:'ğŸš', cat:'ê³¡ë¥˜', intro:'6ê°œì›” ì´í›„' },
  // ë‹¨ë°±ì§ˆ
  { name:'ë‹­ê³ ê¸°', emoji:'ğŸ—', cat:'ë‹¨ë°±ì§ˆ', intro:'7~8ê°œì›”' },
  { name:'ì†Œê³ ê¸°', emoji:'ğŸ¥©', cat:'ë‹¨ë°±ì§ˆ', intro:'6~7ê°œì›”' },
  { name:'ë¼ì§€ê³ ê¸°', emoji:'ğŸ¥©', cat:'ë‹¨ë°±ì§ˆ', intro:'7~8ê°œì›”' },
  { name:'ì—°ì–´', emoji:'ğŸŸ', cat:'ë‹¨ë°±ì§ˆ', intro:'8ê°œì›” ì´í›„' },
  { name:'í°ì‚´ìƒì„ ', emoji:'ğŸŸ', cat:'ë‹¨ë°±ì§ˆ', intro:'7ê°œì›” ì´í›„' },
  { name:'ë‘ë¶€', emoji:'â¬œ', cat:'ë‹¨ë°±ì§ˆ', intro:'6~7ê°œì›”' },
  { name:'ë‹¬ê±€ë…¸ë¥¸ì', emoji:'ğŸ¥š', cat:'ë‹¨ë°±ì§ˆ', intro:'6ê°œì›” ì´í›„' },
  { name:'ë Œí‹¸ì½©', emoji:'ğŸŸ¤', cat:'ë‹¨ë°±ì§ˆ', intro:'7ê°œì›” ì´í›„' },
  // ìœ ì œí’ˆ
  { name:'ìš”ê±°íŠ¸', emoji:'ğŸ¥›', cat:'ìœ ì œí’ˆ', intro:'8ê°œì›” ì´í›„' },
  { name:'ì¹˜ì¦ˆ', emoji:'ğŸ§€', cat:'ìœ ì œí’ˆ', intro:'8ê°œì›” ì´í›„' },
];

let currentFoodCat = 'ì „ì²´';
let selectedFoodName = '';
let selectedFoodEmoji = 'ğŸ¥£';
let selectedReaction = 'ì˜ë¨¹ìŒ';
let selectedFoodStatus = 'ate';
let currentFoodTab = 'all';
let foodRecords = [];

function initFoodPage() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('food-date').value = today;
  loadFoodRecords();
}

function loadFoodRecords() {
  if (currentUser) {
    loadFoodFromFirestore();
  } else {
    foodRecords = JSON.parse(localStorage.getItem('foodRecords') || '[]');
    renderFoodList();
    updateFoodStats();
  }
}

let unsubscribeFood = null;

async function loadFoodFromFirestore() {
  if (!currentUser) return;
  const babyId = getBabyId();
  const q = query(
    collection(db, 'babies', babyId, 'foodRecords'),
    orderBy('createdAt', 'desc')
  );
  if (unsubscribeFood) unsubscribeFood();
  unsubscribeFood = onSnapshot(q, (snap) => {
    foodRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // ë¡œì»¬ì—ë„ ë°±ì—… (ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
    localStorage.setItem('foodRecords', JSON.stringify(foodRecords));
    renderFoodList();
    updateFoodStats();
  });
}

function saveFoodRecords() {
  localStorage.setItem('foodRecords', JSON.stringify(foodRecords));
}

window.selectFoodCat = (btn, cat) => {
  document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFoodCat = cat;
  const query = document.getElementById('food-search-input').value;
  if (query) searchFood(query);
};

window.searchFood = (query) => {
  const resultsEl = document.getElementById('food-search-results');
  if (!query.trim()) {
    resultsEl.classList.remove('show');
    return;
  }
  let filtered = FOOD_DB.filter(f =>
    f.name.includes(query) &&
    (currentFoodCat === 'ì „ì²´' || f.cat === currentFoodCat)
  );
  // ì§ì ‘ ì…ë ¥ ì˜µì…˜ í•­ìƒ ë§¨ ìœ„
  const directOption = { name: query, emoji: 'ğŸ¥£', cat: 'ì§ì ‘ì…ë ¥', intro: '' };
  if (!filtered.find(f => f.name === query)) filtered = [directOption, ...filtered];

  if (filtered.length === 0) {
    resultsEl.classList.remove('show');
    return;
  }
  resultsEl.innerHTML = filtered.slice(0,8).map(f => `
    <div class="food-result-item" onclick="selectFood('${f.name}','${f.emoji}')">
      <span class="f-emoji">${f.emoji}</span>
      <div>
        <div class="f-name">${f.name}</div>
        <div class="f-cat">${f.cat}${f.intro ? ' Â· ë„ì…ì‹œê¸°: ' + f.intro : ''}</div>
      </div>
    </div>
  `).join('');
  resultsEl.classList.add('show');
};

window.selectFood = (name, emoji) => {
  selectedFoodName = name;
  selectedFoodEmoji = emoji;
  document.getElementById('food-search-input').value = name;
  document.getElementById('selected-food-display').textContent = emoji + ' ' + name + ' ì„ íƒë¨';
  document.getElementById('food-search-results').classList.remove('show');
};

window.selectReaction = (btn, reaction) => {
  document.querySelectorAll('.reaction-pill').forEach(b => {
    if (b.closest('.food-reaction-pills') === btn.closest('.food-reaction-pills')) {
      b.classList.remove('active');
    }
  });
  btn.classList.add('active');
  selectedReaction = reaction;
};

window.selectStatus = (status) => {
  selectedFoodStatus = status;
  document.getElementById('status-ate').classList.toggle('active', status === 'ate');
  document.getElementById('status-todo').classList.toggle('active', status === 'todo');
};

window.saveFoodRecord = async () => {
  const name = selectedFoodName || document.getElementById('food-search-input').value.trim();
  if (!name) { showToast('ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const date = document.getElementById('food-date').value;
  const amount = document.getElementById('food-amount').value;
  const memo = document.getElementById('food-memo').value;
  const record = {
    name, emoji: selectedFoodEmoji,
    date, amount, memo,
    reaction: selectedFoodStatus === 'todo' ? 'todo' : selectedReaction,
    status: selectedFoodStatus,
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.uid || 'local',
    createdByName: currentUser?.displayName || 'ë‚˜'
  };

  if (currentUser) {
    try {
      const babyId = getBabyId();
      await addDoc(collection(db, 'babies', babyId, 'foodRecords'), record);
    } catch(e) {
      // ì˜¤í”„ë¼ì¸ ì‹œ ë¡œì»¬ì— ì €ì¥
      record.id = Date.now().toString();
      foodRecords.unshift(record);
      saveFoodRecords();
      renderFoodList();
      updateFoodStats();
    }
  } else {
    record.id = Date.now().toString();
    foodRecords.unshift(record);
    saveFoodRecords();
    renderFoodList();
    updateFoodStats();
  }

  // í¼ ì´ˆê¸°í™”
  document.getElementById('food-search-input').value = '';
  document.getElementById('food-amount').value = '';
  document.getElementById('food-memo').value = '';
  document.getElementById('selected-food-display').textContent = 'ğŸ‘† ìœ„ì—ì„œ ìŒì‹ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”';
  selectedFoodName = '';
  selectedFoodEmoji = 'ğŸ¥£';
  showToast('ğŸ¥£ ì´ìœ ì‹ ê¸°ë¡ ì €ì¥!');
};

window.deleteFoodRecord = async (id) => {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  if (currentUser) {
    try {
      await deleteDoc(doc(db, 'babies', getBabyId(), 'foodRecords', id));
    } catch(e) {
      foodRecords = foodRecords.filter(r => r.id !== id);
      saveFoodRecords();
      renderFoodList();
      updateFoodStats();
    }
  } else {
    foodRecords = foodRecords.filter(r => r.id !== id);
    saveFoodRecords();
    renderFoodList();
    updateFoodStats();
  }
  showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆì–´ìš”');
};

window.switchFoodTab = (btn, tab) => {
  document.querySelectorAll('.food-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFoodTab = tab;
  renderFoodList();
};

function getReactionLabel(reaction) {
  const map = {
    'ì˜ë¨¹ìŒ': { text:'ì˜ë¨¹ìŒ ğŸ˜‹', cls:'good' },
    'ë³´í†µ': { text:'ë³´í†µ ğŸ˜', cls:'warn' },
    'ì•Œë ˆë¥´ê¸°': { text:'ì•Œë ˆë¥´ê¸° âš ï¸', cls:'bad' },
    'ê±°ë¶€': { text:'ê±°ë¶€ ğŸ™…', cls:'reject' },
    'todo': { text:'ì˜ˆì • ğŸ“‹', cls:'todo' },
  };
  return map[reaction] || { text: reaction, cls:'good' };
}

function renderFoodList() {
  let filtered = foodRecords;
  if (currentFoodTab === 'ate') filtered = foodRecords.filter(r => r.status === 'ate');
  else if (currentFoodTab === 'todo') filtered = foodRecords.filter(r => r.status === 'todo');
  else if (currentFoodTab === 'reject') filtered = foodRecords.filter(r => r.reaction === 'ê±°ë¶€' || r.reaction === 'ì•Œë ˆë¥´ê¸°');

  const el = document.getElementById('food-item-list');
  if (!el) return;
  if (filtered.length === 0) {
    el.innerHTML = '<div class="empty-food">ğŸ¥£ ê¸°ë¡ì´ ì—†ì–´ìš”</div>';
    return;
  }
  el.innerHTML = filtered.map(r => {
    const badge = getReactionLabel(r.reaction);
    return `
      <div class="food-item">
        <span class="fi-emoji">${r.emoji}</span>
        <div class="fi-info">
          <div class="fi-name">${r.name}</div>
          <div class="fi-detail">${r.amount ? r.amount + ' Â· ' : ''}${r.memo || ''}</div>
          <div class="fi-date">ğŸ“… ${r.date}</div>
        </div>
        <span class="fi-badge ${badge.cls}">${badge.text}</span>
        <button class="food-del-btn" onclick="deleteFoodRecord('${r.id}')">âœ•</button>
      </div>
    `;
  }).join('');
}

function updateFoodStats() {
  const ateCount = [...new Set(foodRecords.filter(r => r.status === 'ate').map(r => r.name))].length;
  const todoCount = [...new Set(foodRecords.filter(r => r.status === 'todo').map(r => r.name))].length;
  const alertCount = [...new Set(foodRecords.filter(r => r.reaction === 'ì•Œë ˆë¥´ê¸°').map(r => r.name))].length;
  const ateEl = document.getElementById('food-ate-count');
  const todoEl = document.getElementById('food-todo-count');
  const alertEl = document.getElementById('food-alert-count');
  if (ateEl) ateEl.textContent = ateCount;
  if (todoEl) todoEl.textContent = todoCount;
  if (alertEl) alertEl.textContent = alertCount;
}

// ìŒì‹ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', (e) => {
  if (!e.target.closest('.food-search-wrap')) {
    const r = document.getElementById('food-search-results');
    if (r) r.classList.remove('show');
  }
});

</script>
</body>
</html>
